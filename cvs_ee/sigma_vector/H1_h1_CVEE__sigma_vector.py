## h1 <- h1 coupling contributions
from . import logger, tools, ascontiguousarray

# CCAA <- CVEE: NO CONTRIBUTION

# CCEA <- CVEE
def compute_sigma_vector__H1__h1_h1__CCEA_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    ccea__aaaa = mr_adc.h1.ccea__aaaa
    ccea__abab = mr_adc.h1.ccea__abab
    ccea__abba = mr_adc.h1.ccea__abba
    ccea__bbbb = mr_adc.h1.ccea__bbbb 

    ## Indices
    cc_tril_ind = mr_adc.h1.cc_tril_ind 

    ## Two-electron integrals
    v_xaev = mr_adc.v2e.xaev
    v_vxae = mr_adc.v2e.vxae

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca

    sigma_KLCW_aaaa  = einsum('KiCa,LWai->KLCW', X_aaaa, v_xaev, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KiCa,iLWa->KLCW', X_aaaa, v_vxae, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('LiCa,KWai->KLCW', X_aaaa, v_xaev, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('LiCa,iKWa->KLCW', X_aaaa, v_vxae, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_abab, v_xaev, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('LiCa,KWai->KLCW', X_abab, v_xaev, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_aaaa, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_aaaa, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('LiCa,iKxa,Wx->KLCW', X_aaaa, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_abab, v_xaev, rdm_ca, optimize = einsum_type)
    sigma[ccea__aaaa] += ascontiguousarray(sigma_KLCW_aaaa[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    sigma_KLCW_abab  = einsum('KiCa,LWai->KLCW', X_aaaa, v_xaev, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KiCa,LWai->KLCW', X_abab, v_xaev, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KiCa,iLWa->KLCW', X_abab, v_vxae, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('LiaC,iKWa->KLCW', X_baba, v_vxae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_abab, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('LiaC,iKxa,Wx->KLCW', X_baba, v_vxae, rdm_ca, optimize = einsum_type)
    sigma[ccea__abab] += ascontiguousarray(sigma_KLCW_abab).reshape(-1)

    sigma_KLCW_abba  = einsum('KiaC,iLWa->KLCW', X_abab, v_vxae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('LiCa,KWai->KLCW', X_baba, v_xaev, optimize = einsum_type)
    sigma_KLCW_abba += einsum('LiCa,iKWa->KLCW', X_baba, v_vxae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('LiCa,KWai->KLCW', X_bbbb, v_xaev, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KiaC,iLxa,Wx->KLCW', X_abab, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_baba, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('LiCa,iKxa,Wx->KLCW', X_baba, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_bbbb, v_xaev, rdm_ca, optimize = einsum_type)
    sigma[ccea__abba] += ascontiguousarray(sigma_KLCW_abba).reshape(-1)

    sigma_KLCW_bbbb  = einsum('KiCa,LWai->KLCW', X_baba, v_xaev, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('LiCa,KWai->KLCW', X_baba, v_xaev, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KiCa,LWai->KLCW', X_bbbb, v_xaev, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KiCa,iLWa->KLCW', X_bbbb, v_vxae, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('LiCa,KWai->KLCW', X_bbbb, v_xaev, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('LiCa,iKWa->KLCW', X_bbbb, v_vxae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_baba, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_baba, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_bbbb, v_vxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_bbbb, v_xaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('LiCa,iKxa,Wx->KLCW', X_bbbb, v_vxae, rdm_ca, optimize = einsum_type)
    sigma[ccea__bbbb] += ascontiguousarray(sigma_KLCW_bbbb[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CCEA-CVEE", *cput1)

# CCEE <- CVEE
def compute_sigma_vector__H1__h1_h1__CCEE_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    ccee__aaaa = mr_adc.h1.ccee__aaaa
    ccee__abab = mr_adc.h1.ccee__abab
    ccee__bbbb = mr_adc.h1.ccee__bbbb 

    ## Indices
    cc_tril_ind = mr_adc.h1.cc_tril_ind 
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Two-electron integrals
    v_xxxv = mr_adc.v2e.xxxv
    v_xvxx = mr_adc.v2e.xvxx
    v_xeev = mr_adc.v2e.xeev
    v_vxee = mr_adc.v2e.vxee

    sigma_KLCD_aaaa  = einsum('KiCa,LDai->KLCD', X_aaaa, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiCa,iLDa->KLCD', X_aaaa, v_vxee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_aaaa, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiDa,iLCa->KLCD', X_aaaa, v_vxee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiCa,KDai->KLCD', X_aaaa, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiCa,iKDa->KLCD', X_aaaa, v_vxee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiDa,KCai->KLCD', X_aaaa, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiDa,iKCa->KLCD', X_aaaa, v_vxee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('ijCD,KiLj->KLCD', X_aaaa, v_xxxv, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('ijCD,KjLi->KLCD', X_aaaa, v_xvxx, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_abab, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_abab, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiCa,KDai->KLCD', X_abab, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiDa,KCai->KLCD', X_abab, v_xeev, optimize = einsum_type)
    sigma_KLCD_aaaa = sigma_KLCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]
    sigma[ccee__aaaa] += ascontiguousarray(sigma_KLCD_aaaa[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    sigma_KLCD_abab  = einsum('KiCa,LDai->KLCD', X_aaaa, v_xeev, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KiCa,LDai->KLCD', X_abab, v_xeev, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiCa,iLDa->KLCD', X_abab, v_vxee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiaD,iLCa->KLCD', X_abab, v_vxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijCD,KiLj->KLCD', X_abab, v_xxxv, optimize = einsum_type)
    sigma_KLCD_abab += einsum('LiDa,KCai->KLCD', X_baba, v_xeev, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('LiDa,iKCa->KLCD', X_baba, v_vxee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('LiaC,iKDa->KLCD', X_baba, v_vxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijDC,KjLi->KLCD', X_baba, v_xvxx, optimize = einsum_type)
    sigma_KLCD_abab += einsum('LiDa,KCai->KLCD', X_bbbb, v_xeev, optimize = einsum_type)
    sigma[ccee__abab] += ascontiguousarray(sigma_KLCD_abab).reshape(-1)

    sigma_KLCD_bbbb  = einsum('KiCa,LDai->KLCD', X_baba, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_baba, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('LiCa,KDai->KLCD', X_baba, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('LiDa,KCai->KLCD', X_baba, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiCa,LDai->KLCD', X_bbbb, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiCa,iLDa->KLCD', X_bbbb, v_vxee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_bbbb, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiDa,iLCa->KLCD', X_bbbb, v_vxee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('LiCa,KDai->KLCD', X_bbbb, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('LiCa,iKDa->KLCD', X_bbbb, v_vxee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('LiDa,KCai->KLCD', X_bbbb, v_xeev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('LiDa,iKCa->KLCD', X_bbbb, v_vxee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('ijCD,KiLj->KLCD', X_bbbb, v_xxxv, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('ijCD,KjLi->KLCD', X_bbbb, v_xvxx, optimize = einsum_type)
    sigma_KLCD_bbbb = sigma_KLCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]
    sigma[ccee__bbbb] += ascontiguousarray(sigma_KLCD_bbbb[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CCEE-CVEE", *cput1)

# CAEE <- CVEE
def compute_sigma_vector__H1__h1_h1__CAEE_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caee__aaaa = mr_adc.h1.caee__aaaa
    caee__abab = mr_adc.h1.caee__abab
    caee__baba = mr_adc.h1.caee__baba
    caee__bbbb = mr_adc.h1.caee__bbbb 

    ## Indices
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Molecular Orbitals Energies
    e_val = mr_adc.mo_energy.v

    ## One-electron integrals
    h_va = mr_adc.h1eff.va
    h_aa = mr_adc.h1eff.aa

    ## Two-electron integrals
    v_xxva = mr_adc.v2e.xxva
    v_vxxa = mr_adc.v2e.vxxa
    v_vaaa = mr_adc.v2e.vaaa
    v_vaee = mr_adc.v2e.vaee
    v_veea = mr_adc.v2e.veea
    v_aaaa = mr_adc.v2e.aaaa
 
    ## Amplitudes
    t1_va = mr_adc.t1.va
    t1_vaaa = mr_adc.t1.vaaa

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    sigma_KWCD_aaaa =- einsum('KiCD,iW->KWCD', X_aaaa, h_va, optimize = einsum_type)
    sigma_KWCD_aaaa += einsum('KiCD,i,iW->KWCD', X_aaaa, e_val, t1_va, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,Wx,ix->KWCD', X_aaaa, h_aa, t1_va, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,iWxy,yx->KWCD', X_aaaa, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyW,xy->KWCD', X_aaaa, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_aaaa, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_aaaa, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_aaaa, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiDa,ixCa,Wx->KWCD', X_aaaa, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('ijCD,iKjx,Wx->KWCD', X_aaaa, v_xxva, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('ijCD,jKix,Wx->KWCD', X_aaaa, v_vxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_abab, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_abab, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += einsum('KiCD,i,ixWy,yx->KWCD', X_aaaa, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,i,ixyW,yx->KWCD', X_aaaa, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,Wx,iyxz,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,Wx,iyzx,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += einsum('KiCD,xy,ixWz,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,xy,ixzW,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,xy,izWx,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,xy,izxW,yz->KWCD', X_aaaa, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,ix,Wxyz,yz->KWCD', X_aaaa, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ix,Wyzx,zy->KWCD', X_aaaa, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += einsum('KiCD,ixWy,xzwu,ywzu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,ixWy,yzwu,xwzu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ixyW,xzwu,ywzu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyW,yzwu,xwzu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyz,Wwuy,xwzu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyz,Wwuz,xwuy->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ixyz,Wwxu,yzwu->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,ixyz,Wywu,xuzw->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= einsum('KiCD,ixyz,Wywz,xw->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyz,Wzwu,xuyw->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyz,Wzwy,xw->KWCD', X_aaaa, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[caee__aaaa] += ascontiguousarray(sigma_KWCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    sigma_KWCD_abab =- einsum('KiCD,iW->KWCD', X_abab, h_va, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_aaaa, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += einsum('KiCD,i,iW->KWCD', X_abab, e_val, t1_va, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,Wx,ix->KWCD', X_abab, h_aa, t1_va, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,iWxy,yx->KWCD', X_abab, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyW,xy->KWCD', X_abab, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_abab, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_abab, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiaD,ixCa,Wx->KWCD', X_abab, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('ijCD,iKjx,Wx->KWCD', X_abab, v_xxva, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('ijDC,jKix,Wx->KWCD', X_baba, v_vxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += einsum('KiCD,i,ixWy,yx->KWCD', X_abab, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,i,ixyW,yx->KWCD', X_abab, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,Wx,iyxz,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,Wx,iyzx,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += einsum('KiCD,xy,ixWz,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,xy,ixzW,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,xy,izWx,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,xy,izxW,yz->KWCD', X_abab, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,ix,Wxyz,yz->KWCD', X_abab, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ix,Wyzx,zy->KWCD', X_abab, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += einsum('KiCD,ixWy,xzwu,ywzu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,ixWy,yzwu,xwzu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ixyW,xzwu,ywzu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyW,yzwu,xwzu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyz,Wwuy,xwzu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyz,Wwuz,xwuy->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ixyz,Wwxu,yzwu->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,ixyz,Wywu,xuzw->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= einsum('KiCD,ixyz,Wywz,xw->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyz,Wzwu,xuyw->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyz,Wzwy,xw->KWCD', X_abab, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[caee__abab] += ascontiguousarray(sigma_KWCD_abab).reshape(-1)

    sigma_KWCD_baba =- einsum('KiCD,iW->KWCD', X_baba, h_va, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('ijDC,jKix,Wx->KWCD', X_abab, v_vxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += einsum('KiCD,i,iW->KWCD', X_baba, e_val, t1_va, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,Wx,ix->KWCD', X_baba, h_aa, t1_va, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,iWxy,yx->KWCD', X_baba, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyW,xy->KWCD', X_baba, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_baba, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_baba, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiaD,ixCa,Wx->KWCD', X_baba, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('ijCD,iKjx,Wx->KWCD', X_baba, v_xxva, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_bbbb, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += einsum('KiCD,i,ixWy,yx->KWCD', X_baba, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiCD,i,ixyW,yx->KWCD', X_baba, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,Wx,iyxz,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,Wx,iyzx,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += einsum('KiCD,xy,ixWz,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiCD,xy,ixzW,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,xy,izWx,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,xy,izxW,yz->KWCD', X_baba, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,ix,Wxyz,yz->KWCD', X_baba, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ix,Wyzx,zy->KWCD', X_baba, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += einsum('KiCD,ixWy,xzwu,ywzu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,ixWy,yzwu,xwzu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiCD,ixyW,xzwu,ywzu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyW,yzwu,xwzu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyz,Wwuy,xwzu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyz,Wwuz,xwuy->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('KiCD,ixyz,Wwxu,yzwu->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,ixyz,Wywu,xuzw->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= einsum('KiCD,ixyz,Wywz,xw->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyz,Wzwu,xuyw->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCD,ixyz,Wzwy,xw->KWCD', X_baba, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[caee__baba] += ascontiguousarray(sigma_KWCD_baba).reshape(-1)

    sigma_KWCD_bbbb =- einsum('KiCD,iW->KWCD', X_bbbb, h_va, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_baba, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_baba, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += einsum('KiCD,i,iW->KWCD', X_bbbb, e_val, t1_va, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,Wx,ix->KWCD', X_bbbb, h_aa, t1_va, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,iWxy,yx->KWCD', X_bbbb, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyW,xy->KWCD', X_bbbb, v_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_bbbb, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_bbbb, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_bbbb, v_veea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiDa,ixCa,Wx->KWCD', X_bbbb, v_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('ijCD,iKjx,Wx->KWCD', X_bbbb, v_xxva, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('ijCD,jKix,Wx->KWCD', X_bbbb, v_vxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += einsum('KiCD,i,ixWy,yx->KWCD', X_bbbb, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,i,ixyW,yx->KWCD', X_bbbb, e_val, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,Wx,iyxz,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,Wx,iyzx,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += einsum('KiCD,xy,ixWz,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,xy,ixzW,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,xy,izWx,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,xy,izxW,yz->KWCD', X_bbbb, h_aa, t1_vaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,ix,Wxyz,yz->KWCD', X_bbbb, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ix,Wyzx,zy->KWCD', X_bbbb, t1_va, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += einsum('KiCD,ixWy,xzwu,ywzu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,ixWy,yzwu,xwzu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ixyW,xzwu,ywzu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyW,yzwu,xwzu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyz,Wwuy,xwzu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyz,Wwuz,xwuy->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ixyz,Wwxu,yzwu->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,ixyz,Wywu,xuzw->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= einsum('KiCD,ixyz,Wywz,xw->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyz,Wzwu,xuyw->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyz,Wzwy,xw->KWCD', X_bbbb, t1_vaaa, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[caee__bbbb] += ascontiguousarray(sigma_KWCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAEE-CVEE", *cput1)

# CAAA <- CVEE
def compute_sigma_vector__H1__h1_h1__CAAA_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caaa__aaaa = mr_adc.h1.caaa__aaaa
    caaa__abab = mr_adc.h1.caaa__abab
    caaa__baba = mr_adc.h1.caaa__baba
    caaa__bbbb = mr_adc.h1.caaa__bbbb 

    ## Indices
    aa_tril_ind = mr_adc.h1.aa_tril_ind 

    ## Molecular Orbitals Energies
    e_val = mr_adc.mo_energy.v
    e_extern = mr_adc.mo_energy.e

    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa

    ## Two-electron integrals
    v_veae = mr_adc.v2e.veae
    v_aaaa = mr_adc.v2e.aaaa
  
    ## Amplitudes
    t1_vaee = mr_adc.t1.vaee
  
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    sigma_KWUV_aaaa =- 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,iaVb,UW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ibVa,UW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_abab, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ibVa,UW->KWUV', X_abab, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iVab,UW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,i,iVab,UW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,i,iVba,UW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,Vx,ixab,UW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,Vx,ixba,UW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixab,UyVx,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixab,Vxyz,UzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,Wyxz,UVyz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,Wyxz,UVzy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,a,iVba,UW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_abab, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,i,iVba,UW->KWUV', X_abab, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_abab, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,Vx,ixba,UW->KWUV', X_abab, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caaa__aaaa] += ascontiguousarray(sigma_KWUV_aaaa[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1)

    sigma_KWUV_abab =- 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_aaaa, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_abab, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_aaaa, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_aaaa, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_aaaa, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixab,Wyxz,UVyz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixab,Wyxz,UVzy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_aaaa, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_abab, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_abab, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_abab, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/3 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_abab, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caaa__abab] += ascontiguousarray(sigma_KWUV_abab).reshape(-1)

    sigma_KWUV_baba  = 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_baba, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_baba, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_baba, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/3 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixab,Wyxz,UVyz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixab,Wyxz,UVzy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caaa__baba] += ascontiguousarray(sigma_KWUV_baba).reshape(-1)

    sigma_KWUV_bbbb  = 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_baba, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,ibVa,UW->KWUV', X_baba, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,iaVb,UW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ibVa,UW->KWUV', X_bbbb, v_veae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,a,iVba,UW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_baba, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_baba, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,i,iVba,UW->KWUV', X_baba, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_baba, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,Vx,ixba,UW->KWUV', X_baba, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_baba, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,b,iVab,UW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_bbbb, e_extern, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,i,iVab,UW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,i,iVba,UW->KWUV', X_bbbb, e_val, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,Vx,ixab,UW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,Vx,ixba,UW->KWUV', X_bbbb, h_aa, t1_vaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixab,UyVx,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixab,Vxyz,UzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,Wyxz,UVyz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,Wyxz,UVzy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,Wyxz,UVyz->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,Wyxz,UVzy->KWUV', X_bbbb, t1_vaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caaa__bbbb] += ascontiguousarray(sigma_KWUV_bbbb[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAAA-CVEE", *cput1)

# CAEA <- CVEE
def compute_sigma_vector__H1__h1_h1__CAEA_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caea__aaaa = mr_adc.h1.caea__aaaa
    caea__abab = mr_adc.h1.caea__abab
    caea__baab = mr_adc.h1.caea__baab
    caea__bbbb = mr_adc.h1.caea__bbbb
    caea__baba = mr_adc.h1.caea__baba
    caea__abba = mr_adc.h1.caea__abba 

    ## Molecular Orbitals Energies
    e_val = mr_adc.mo_energy.v
    e_extern = mr_adc.mo_energy.e
 
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa
 
    ## Two-electron integrals
    v_xxve = mr_adc.v2e.xxve
    v_vxxe = mr_adc.v2e.vxxe
    v_vaae = mr_adc.v2e.vaae
    v_veaa = mr_adc.v2e.veaa
    v_veee = mr_adc.v2e.veee
    v_aaaa = mr_adc.v2e.aaaa

    ## Amplitudes
    t1_vaae = mr_adc.t1.vaae
    t1_vaea = mr_adc.t1.vaea
   
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    sigma_KWCU_aaaa  = 1/2 * einsum('KiCa,iWxa,Ux->KWCU', X_aaaa, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_aaaa, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_aaaa, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_aaaa, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_aaaa, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_aaaa, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_aaaa, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('ijCa,jKia,UW->KWCU', X_aaaa, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_abab, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_abab, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_abab, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_abab, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('ijaC,jKia,UW->KWCU', X_baba, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_aaaa, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_aaaa, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,ixWa,Ux->KWCU', X_aaaa, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_aaaa, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_aaaa, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_aaaa, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,ixWa,Ux->KWCU', X_aaaa, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_aaaa, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_aaaa, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,Wx,iyxa,Uy->KWCU', X_aaaa, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_aaaa, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,xy,ixWa,Uy->KWCU', X_aaaa, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixWa,xyzw,Uzyw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixya,Wyzw,Uzxw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_abab, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_abab, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_abab, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_abab, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__aaaa] += ascontiguousarray(sigma_KWCU_aaaa).reshape(-1)

    sigma_KWCU_abab  = 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_aaaa, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_aaaa, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_aaaa, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_aaaa, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_aaaa, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('ijCa,jKia,UW->KWCU', X_aaaa, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iWxa,Ux->KWCU', X_abab, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_abab, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_abab, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_abab, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_abab, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_abab, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('ijaC,jKia,UW->KWCU', X_baba, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_aaaa, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_aaaa, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_aaaa, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_aaaa, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_aaaa, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_aaaa, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_aaaa, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_abab, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,ixWa,Ux->KWCU', X_abab, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_abab, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_abab, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_abab, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,ixWa,Ux->KWCU', X_abab, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_abab, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,Wx,iyxa,Uy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,xy,ixWa,Uy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_abab, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixWa,xyzw,Uzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_abab, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixya,Wyzw,Uzxw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__abab] += ascontiguousarray(sigma_KWCU_abab).reshape(-1)

    sigma_KWCU_baab =- 1/2 * einsum('KiaC,iWxa,Ux->KWCU', X_baba, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,ixUa,Wx->KWCU', X_baba, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,a,iUxa,Wx->KWCU', X_baba, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,a,ixWa,Ux->KWCU', X_baba, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,i,iUxa,Wx->KWCU', X_baba, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,i,ixWa,Ux->KWCU', X_baba, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,Ux,ixya,Wy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,Wx,iyxa,Uy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,xy,iUxa,Wy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,xy,ixWa,Uy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,iUxa,xyzw,Wzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('KiaC,ixWa,xyzw,Uzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,ixya,Uxzw,Wzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/3 * einsum('KiaC,ixya,Uzwx,Wwyz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('KiaC,ixya,Uzwx,Wwzy->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('KiaC,ixya,Uzyw,Wxwz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('KiaC,ixya,Uzyw,Wxzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('KiaC,ixya,Wyzw,Uzxw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/3 * einsum('KiaC,ixya,Wzwy,Uwxz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('KiaC,ixya,Wzwy,Uwzx->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('KiaC,ixya,Wzxw,Uywz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('KiaC,ixya,Wzxw,Uyzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__baab] += ascontiguousarray(sigma_KWCU_baab).reshape(-1)

    sigma_KWCU_bbbb =- 1/2 * einsum('ijaC,jKia,UW->KWCU', X_abab, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_baba, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_baba, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_baba, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_baba, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iWxa,Ux->KWCU', X_bbbb, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_bbbb, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_bbbb, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_bbbb, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_bbbb, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_bbbb, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_bbbb, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('ijCa,jKia,UW->KWCU', X_bbbb, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_baba, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_baba, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_baba, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_baba, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_bbbb, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_bbbb, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,ixWa,Ux->KWCU', X_bbbb, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_bbbb, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_bbbb, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_bbbb, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,ixWa,Ux->KWCU', X_bbbb, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_bbbb, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_bbbb, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,Wx,iyxa,Uy->KWCU', X_bbbb, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_bbbb, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,xy,ixWa,Uy->KWCU', X_bbbb, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixWa,xyzw,Uzyw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixya,Wyzw,Uzxw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__bbbb] += ascontiguousarray(sigma_KWCU_bbbb).reshape(-1)

    sigma_KWCU_baba =- 1/2 * einsum('ijaC,jKia,UW->KWCU', X_abab, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iWxa,Ux->KWCU', X_baba, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_baba, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_baba, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_baba, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_baba, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_baba, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_bbbb, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,iaxW,Ux->KWCU', X_bbbb, v_veaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_bbbb, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_bbbb, v_veee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_bbbb, v_xxve, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('ijCa,jKia,UW->KWCU', X_bbbb, v_vxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_baba, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_baba, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,ixWa,Ux->KWCU', X_baba, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_baba, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_baba, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_baba, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,ixWa,Ux->KWCU', X_baba, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_baba, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,Wx,iyxa,Uy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,xy,ixWa,Uy->KWCU', X_baba, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_baba, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixWa,xyzw,Uzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_baba, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixya,Wyzw,Uzxw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_baba, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_bbbb, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,a,ixaW,Ux->KWCU', X_bbbb, e_extern, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_bbbb, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,i,ixaW,Ux->KWCU', X_bbbb, e_val, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,Wx,iyax,Uy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,ixaW,Uy->KWCU', X_bbbb, h_aa, t1_vaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixaW,xyzw,Uzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Wyzw,Uzxw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Wzwy,Uwzx->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,Wzxw,Uyzw->KWCU', X_bbbb, t1_vaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Wzwy,Uwxz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,ixya,Wzwy,Uwzx->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Wzxw,Uywz->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,ixya,Wzxw,Uyzw->KWCU', X_bbbb, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__baba] += ascontiguousarray(sigma_KWCU_baba).reshape(-1)

    sigma_KWCU_abba =- 1/2 * einsum('KiaC,iWxa,Ux->KWCU', X_abab, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,ixUa,Wx->KWCU', X_abab, v_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,a,ixWa,Ux->KWCU', X_abab, e_extern, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,i,iUxa,Wx->KWCU', X_abab, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,i,ixWa,Ux->KWCU', X_abab, e_val, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,Wx,iyxa,Uy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,xy,ixWa,Uy->KWCU', X_abab, h_aa, t1_vaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,ixWa,xyzw,Uzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/3 * einsum('KiaC,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,ixya,Wyzw,Uzxw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/3 * einsum('KiaC,ixya,Wzwy,Uwxz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,Wzwy,Uwzx->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,ixya,Wzxw,Uywz->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,Wzxw,Uyzw->KWCU', X_abab, t1_vaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[caea__abba] += ascontiguousarray(sigma_KWCU_abba).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAEA-CVEE", *cput1)

# CVAA <- CVEE
def compute_sigma_vector__H1__h1_h1__CVAA_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    cvaa__aaaa = mr_adc.h1.cvaa__aaaa
    cvaa__abab = mr_adc.h1.cvaa__abab
    cvaa__baba = mr_adc.h1.cvaa__baba
    cvaa__bbbb = mr_adc.h1.cvaa__bbbb 

    ## Indices
    aa_tril_ind = mr_adc.h1.aa_tril_ind 

    ## Molecular Orbitals Energies
    e_extern = mr_adc.mo_energy.e
    
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa

    ## Two-electron integrals
    v_aeae = mr_adc.v2e.aeae
    v_aaaa = mr_adc.v2e.aaaa

    ## Amplitudes
    t1_aaee = mr_adc.t1.aaee

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    sigma_KLWU_aaaa =- 1/2 * einsum('KLab,UaWb->KLWU', X_aaaa, v_aeae, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,UbWa->KLWU', X_aaaa, v_aeae, optimize = einsum_type)
    sigma_KLWU_aaaa -= einsum('KLab,b,UWab->KLWU', X_aaaa, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += einsum('KLab,b,UWba->KLWU', X_aaaa, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Ux,Wxab->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Ux,Wxba->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Wx,Uxab->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Wx,Uxba->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,xyab,UxWy->KLWU', X_aaaa, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,xyab,UyWx->KLWU', X_aaaa, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uaxb,Wx->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Ubxa,Wx->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Waxb,Ux->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wbxa,Ux->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,b,Uxab,Wx->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,b,Wxba,Ux->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Ux,xyab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Ux,yxab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wx,xyab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wx,yxab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xy,Uxab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xy,Uxba,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xy,Wxab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xy,Wxba,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Uxab,Wxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Uxab,Wyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Uxab,xyzw,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Uxba,Wxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Wxab,Uxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Wxba,Uxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wxba,Uyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wxba,xyzw,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,UxWz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Uxzw,Wwyz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Uxzy,Wz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,UyWz,xz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,UzWx,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,UzWy,xz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Wyzw,Uwxz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Wyzx,Uz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[cvaa__aaaa] += ascontiguousarray(sigma_KLWU_aaaa[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1) 

    sigma_KLWU_abab  = einsum('KLab,UbWa->KLWU', X_abab, v_aeae, optimize = einsum_type)
    sigma_KLWU_abab += einsum('KLab,a,UWba->KLWU', X_abab, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab += einsum('KLab,b,UWba->KLWU', X_abab, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Ux,Wxab->KLWU', X_abab, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Wx,Uxba->KLWU', X_abab, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,xyab,UyWx->KLWU', X_abab, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,Ubxa,Wx->KLWU', X_abab, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,Waxb,Ux->KLWU', X_abab, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,a,Uxba,Wx->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,a,Wxab,Ux->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Ux,yxab,Wy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wx,xyab,Uy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xy,Uxba,Wy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xy,Wxab,Uy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Uxba,Wxyz,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Wxab,Uxyz,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,UyWz,xz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,UzWx,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[cvaa__abab] += ascontiguousarray(sigma_KLWU_abab).reshape(-1) 

    sigma_KLWU_baba  = einsum('KLab,UbWa->KLWU', X_baba, v_aeae, optimize = einsum_type)
    sigma_KLWU_baba += einsum('KLab,a,UWba->KLWU', X_baba, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_baba += einsum('KLab,b,UWba->KLWU', X_baba, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_baba -= einsum('KLab,Ux,Wxab->KLWU', X_baba, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_baba -= einsum('KLab,Wx,Uxba->KLWU', X_baba, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_baba -= einsum('KLab,xyab,UyWx->KLWU', X_baba, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,Ubxa,Wx->KLWU', X_baba, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,Waxb,Ux->KLWU', X_baba, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,a,Uxba,Wx->KLWU', X_baba, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,a,Wxab,Ux->KLWU', X_baba, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_baba, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_baba, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Ux,yxab,Wy->KLWU', X_baba, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Wx,xyab,Uy->KLWU', X_baba, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xy,Uxba,Wy->KLWU', X_baba, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xy,Wxab,Uy->KLWU', X_baba, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= einsum('KLab,Uxba,Wxyz,yz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= einsum('KLab,Wxab,Uxyz,yz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,UyWz,xz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,UzWx,yz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/3 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/6 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/6 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/3 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba += 1/2 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_baba -= 1/6 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/3 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/3 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_baba -= 1/6 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_baba, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[cvaa__baba] += ascontiguousarray(sigma_KLWU_baba).reshape(-1) 

    sigma_KLWU_bbbb =- 1/2 * einsum('KLab,UaWb->KLWU', X_bbbb, v_aeae, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,UbWa->KLWU', X_bbbb, v_aeae, optimize = einsum_type)
    sigma_KLWU_bbbb -= einsum('KLab,b,UWab->KLWU', X_bbbb, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += einsum('KLab,b,UWba->KLWU', X_bbbb, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Ux,Wxab->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Ux,Wxba->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Wx,Uxab->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Wx,Uxba->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,xyab,UxWy->KLWU', X_bbbb, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,xyab,UyWx->KLWU', X_bbbb, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uaxb,Wx->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Ubxa,Wx->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Waxb,Ux->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wbxa,Ux->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,b,Uxab,Wx->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,b,Wxba,Ux->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Ux,xyab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Ux,yxab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wx,xyab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wx,yxab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xy,Uxab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xy,Uxba,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xy,Wxab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xy,Wxba,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Uxab,Wxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Uxab,Wyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Uxab,xyzw,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Uxba,Wxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Wxab,Uxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Wxba,Uxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wxba,Uyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wxba,xyzw,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,UxWz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Uxzw,Wwyz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Uxzy,Wz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,UyWz,xz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,UzWx,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,UzWy,xz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Wyzw,Uwxz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Wyzx,Uz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma[cvaa__bbbb] += ascontiguousarray(sigma_KLWU_bbbb[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1) 

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CVAA-CVEE", *cput1)

# CVEA <- CVEE
def compute_sigma_vector__H1__h1_h1__CVEA_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    cvea__aaaa = mr_adc.h1.cvea__aaaa
    cvea__abab = mr_adc.h1.cvea__abab
    cvea__baab = mr_adc.h1.cvea__baab
    cvea__bbbb = mr_adc.h1.cvea__bbbb
    cvea__baba = mr_adc.h1.cvea__baba
    cvea__abba = mr_adc.h1.cvea__abba 
 
    ## Molecular Orbitals Energies
    e_extern = mr_adc.mo_energy.e
    
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa
    h_ae = mr_adc.h1eff.ae

    ## Two-electron integrals
    v_xxae = mr_adc.v2e.xxae
    v_xaex = mr_adc.v2e.xaex
    v_vvae = mr_adc.v2e.vvae
    v_vaev = mr_adc.v2e.vaev
    v_aaaa = mr_adc.v2e.aaaa
    v_aaae = mr_adc.v2e.aaae
    v_aeee = mr_adc.v2e.aeee

    ## Amplitudes
    t1_ae = mr_adc.t1.ae
    t1_aaae = mr_adc.t1.aaae
    
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    sigma_KLCW_aaaa  = einsum('KLCa,Wa->KLCW', X_aaaa, h_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLab,WaCb->KLCW', X_aaaa, v_aeee, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLab,WbCa->KLCW', X_aaaa, v_aeee, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_aaaa, v_vaev, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KiCa,iLWa->KLCW', X_aaaa, v_vvae, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('iLCa,KWai->KLCW', X_aaaa, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('iLCa,iKWa->KLCW', X_aaaa, v_xxae, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_abab, v_vaev, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('iLaC,KWai->KLCW', X_baba, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,a,Wa->KLCW', X_aaaa, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,Wx,xa->KLCW', X_aaaa, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_aaaa, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xyWa,xy->KLCW', X_aaaa, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/4 * einsum('KLab,xaCb,Wx->KLCW', X_aaaa, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/4 * einsum('KLab,xbCa,Wx->KLCW', X_aaaa, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_aaaa, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('iLCa,Kxai,Wx->KLCW', X_aaaa, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('iLCa,iKxa,Wx->KLCW', X_aaaa, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_baba, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_aaaa, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,a,xWya,xy->KLCW', X_aaaa, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,Wx,yxza,zy->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xy,xWza,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xy,zWxa,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_aaaa, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_aaaa, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__aaaa] += ascontiguousarray(sigma_KLCW_aaaa).reshape(-1)

    sigma_KLCW_abab  = einsum('KiCa,LWai->KLCW', X_aaaa, v_vaev, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,Wa->KLCW', X_abab, h_ae, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLab,WbCa->KLCW', X_abab, v_aeee, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KiCa,LWai->KLCW', X_abab, v_vaev, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KiCa,iLWa->KLCW', X_abab, v_vvae, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('iLCa,iKWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,a,Wa->KLCW', X_abab, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,Wx,xa->KLCW', X_abab, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xyWa,xy->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLab,xbCa,Wx->KLCW', X_abab, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_abab, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('iLCa,iKxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,a,xWya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,Wx,yxza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xy,xWza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xy,zWxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__abab] += ascontiguousarray(sigma_KLCW_abab).reshape(-1)

    sigma_KLCW_baab  = einsum('iLCa,KWai->KLCW', X_aaaa, v_xaex, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,Wa->KLCW', X_baba, h_ae, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLab,WaCb->KLCW', X_baba, v_aeee, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KiaC,iLWa->KLCW', X_baba, v_vvae, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('iLaC,KWai->KLCW', X_baba, v_xaex, optimize = einsum_type)
    sigma_KLCW_baab += einsum('iLaC,iKWa->KLCW', X_baba, v_xxae, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('iLCa,Kxai,Wx->KLCW', X_aaaa, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,a,Wa->KLCW', X_baba, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,Wx,xa->KLCW', X_baba, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLaC,Wxya,yx->KLCW', X_baba, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,xyWa,xy->KLCW', X_baba, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLab,xaCb,Wx->KLCW', X_baba, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KiaC,iLxa,Wx->KLCW', X_baba, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_baba, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('iLaC,iKxa,Wx->KLCW', X_baba, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLaC,a,Wxya,xy->KLCW', X_baba, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,a,xWya,xy->KLCW', X_baba, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,Wx,xyza,zy->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,Wx,yxza,zy->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xy,Wxza,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLaC,xy,Wzxa,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,xy,xWza,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,xy,zWxa,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,Wxya,xzwu,ywzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLaC,Wxya,yzwu,xwzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,xWya,xzwu,ywzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab -= einsum('KLaC,xWya,yzwu,xwzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,xa,Wxyz,yz->KLCW', X_baba, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xa,Wyzx,zy->KLCW', X_baba, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xyza,Wwux,zwuy->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xyza,Wwuy,zwxu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab += 1/2 * einsum('KLaC,xyza,Wwzu,yxwu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xyza,Wxwu,zuyw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('KLaC,xyza,Wxwy,zw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,xyza,Wywu,zuxw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baab += einsum('KLaC,xyza,Wywx,zw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__baab] += ascontiguousarray(sigma_KLCW_baab).reshape(-1)

    sigma_KLCW_bbbb =- einsum('iLaC,KWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KiCa,LWai->KLCW', X_baba, v_vaev, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,Wa->KLCW', X_bbbb, h_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLab,WaCb->KLCW', X_bbbb, v_aeee, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLab,WbCa->KLCW', X_bbbb, v_aeee, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KiCa,LWai->KLCW', X_bbbb, v_vaev, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KiCa,iLWa->KLCW', X_bbbb, v_vvae, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('iLCa,KWai->KLCW', X_bbbb, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('iLCa,iKWa->KLCW', X_bbbb, v_xxae, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_baba, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,a,Wa->KLCW', X_bbbb, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,Wx,xa->KLCW', X_bbbb, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_bbbb, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xyWa,xy->KLCW', X_bbbb, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/4 * einsum('KLab,xaCb,Wx->KLCW', X_bbbb, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/4 * einsum('KLab,xbCa,Wx->KLCW', X_bbbb, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_bbbb, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('iLCa,Kxai,Wx->KLCW', X_bbbb, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('iLCa,iKxa,Wx->KLCW', X_bbbb, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_bbbb, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,a,xWya,xy->KLCW', X_bbbb, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,Wx,yxza,zy->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xy,xWza,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xy,zWxa,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_bbbb, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_bbbb, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__bbbb] += ascontiguousarray(sigma_KLCW_bbbb).reshape(-1)

    sigma_KLCW_baba  = einsum('KLCa,Wa->KLCW', X_baba, h_ae, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLab,WbCa->KLCW', X_baba, v_aeee, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KiCa,LWai->KLCW', X_baba, v_vaev, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KiCa,iLWa->KLCW', X_baba, v_vvae, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('iLCa,iKWa->KLCW', X_baba, v_xxae, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KiCa,LWai->KLCW', X_bbbb, v_vaev, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLCa,a,Wa->KLCW', X_baba, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,Wx,xa->KLCW', X_baba, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_baba, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLCa,xyWa,xy->KLCW', X_baba, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLab,xbCa,Wx->KLCW', X_baba, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_baba, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_baba, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('iLCa,iKxa,Wx->KLCW', X_baba, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_vaev, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_baba, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLCa,a,xWya,xy->KLCW', X_baba, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,Wx,yxza,zy->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,xy,xWza,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLCa,xy,zWxa,yz->KLCW', X_baba, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_baba, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_baba, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_baba, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__baba] += ascontiguousarray(sigma_KLCW_baba).reshape(-1)

    sigma_KLCW_abba =- einsum('KLaC,Wa->KLCW', X_abab, h_ae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLab,WaCb->KLCW', X_abab, v_aeee, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KiaC,iLWa->KLCW', X_abab, v_vvae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('iLaC,KWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_abba += einsum('iLaC,iKWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abba += einsum('iLCa,KWai->KLCW', X_bbbb, v_xaex, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,a,Wa->KLCW', X_abab, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,Wx,xa->KLCW', X_abab, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,Wxya,yx->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xyWa,xy->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLab,xaCb,Wx->KLCW', X_abab, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KiaC,iLxa,Wx->KLCW', X_abab, v_vvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('iLaC,iKxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('iLCa,Kxai,Wx->KLCW', X_bbbb, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,a,Wxya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,a,xWya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,Wx,xyza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,Wx,yxza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xy,Wxza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xy,Wzxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xy,xWza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xy,zWxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,Wxya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,Wxya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xWya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xWya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xa,Wxyz,yz->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xa,Wyzx,zy->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wwux,zwuy->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wwuy,zwxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xyza,Wwzu,yxwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wxwu,zuyw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wxwy,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xyza,Wywu,zuxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xyza,Wywx,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma[cvea__abba] += ascontiguousarray(sigma_KLCW_abba).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CVEA-CVEE", *cput1)

# CVEE <- CVEE
def compute_sigma_vector__H1__h1_h1__CVEE_CVEE(mr_adc, X_aaaa, X_abab, X_baba, X_bbbb, sigma):        
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    cvee__aaaa = mr_adc.h1.cvee__aaaa
    cvee__abab = mr_adc.h1.cvee__abab
    cvee__baba = mr_adc.h1.cvee__baba
    cvee__bbbb = mr_adc.h1.cvee__bbbb 

    ## Indices
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Two-electron integrals
    v_xxvv = mr_adc.v2e.xxvv
    v_xxee = mr_adc.v2e.xxee
    v_xvvx = mr_adc.v2e.xvvx
    v_xeex = mr_adc.v2e.xeex
    v_vvee = mr_adc.v2e.vvee
    v_veev = mr_adc.v2e.veev
    v_eeee = mr_adc.v2e.eeee

    sigma_KLCD_aaaa  = 1/2 * einsum('KLab,CaDb->KLCD', X_aaaa, v_eeee, optimize = einsum_type)
    sigma_KLCD_aaaa -= 1/2 * einsum('KLab,CbDa->KLCD', X_aaaa, v_eeee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_aaaa, v_veev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiCa,iLDa->KLCD', X_aaaa, v_vvee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_aaaa, v_veev, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiDa,iLCa->KLCD', X_aaaa, v_vvee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('iLCa,KDai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('iLCa,iKDa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('iLDa,KCai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('iLDa,iKCa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('ijCD,KiLj->KLCD', X_aaaa, v_xxvv, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('ijCD,KjLi->KLCD', X_aaaa, v_xvvx, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_abab, v_veev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_abab, v_veev, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('iLaC,KDai->KLCD', X_baba, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('iLaD,KCai->KLCD', X_baba, v_xeex, optimize = einsum_type)
    sigma[cvee__aaaa] += ascontiguousarray(sigma_KLCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)
 
    sigma_KLCD_abab  = einsum('KiCa,LDai->KLCD', X_aaaa, v_veev, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KLab,CaDb->KLCD', X_abab, v_eeee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KiCa,LDai->KLCD', X_abab, v_veev, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiCa,iLDa->KLCD', X_abab, v_vvee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiaD,iLCa->KLCD', X_abab, v_vvee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('iLCa,iKDa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('iLaD,KCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('iLaD,iKCa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijCD,KiLj->KLCD', X_abab, v_xxvv, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijDC,KjLi->KLCD', X_baba, v_xvvx, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('iLDa,KCai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma[cvee__abab] += ascontiguousarray(sigma_KLCD_abab).reshape(-1)

    sigma_KLCD_baba =- einsum('iLDa,KCai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_baba += einsum('ijDC,KjLi->KLCD', X_abab, v_xvvx, optimize = einsum_type)
    sigma_KLCD_baba += einsum('KLab,CaDb->KLCD', X_baba, v_eeee, optimize = einsum_type)
    sigma_KLCD_baba += einsum('KiCa,LDai->KLCD', X_baba, v_veev, optimize = einsum_type)
    sigma_KLCD_baba -= einsum('KiCa,iLDa->KLCD', X_baba, v_vvee, optimize = einsum_type)
    sigma_KLCD_baba -= einsum('KiaD,iLCa->KLCD', X_baba, v_vvee, optimize = einsum_type)
    sigma_KLCD_baba -= einsum('iLCa,iKDa->KLCD', X_baba, v_xxee, optimize = einsum_type)
    sigma_KLCD_baba += einsum('iLaD,KCai->KLCD', X_baba, v_xeex, optimize = einsum_type)
    sigma_KLCD_baba -= einsum('iLaD,iKCa->KLCD', X_baba, v_xxee, optimize = einsum_type)
    sigma_KLCD_baba += einsum('ijCD,KiLj->KLCD', X_baba, v_xxvv, optimize = einsum_type)
    sigma_KLCD_baba += einsum('KiCa,LDai->KLCD', X_bbbb, v_veev, optimize = einsum_type)
    sigma[cvee__baba] += ascontiguousarray(sigma_KLCD_baba).reshape(-1)

    sigma_KLCD_bbbb =- einsum('iLaC,KDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('iLaD,KCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiCa,LDai->KLCD', X_baba, v_veev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_baba, v_veev, optimize = einsum_type)
    sigma_KLCD_bbbb += 1/2 * einsum('KLab,CaDb->KLCD', X_bbbb, v_eeee, optimize = einsum_type)
    sigma_KLCD_bbbb -= 1/2 * einsum('KLab,CbDa->KLCD', X_bbbb, v_eeee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiCa,LDai->KLCD', X_bbbb, v_veev, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiCa,iLDa->KLCD', X_bbbb, v_vvee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_bbbb, v_veev, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiDa,iLCa->KLCD', X_bbbb, v_vvee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('iLCa,KDai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('iLCa,iKDa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('iLDa,KCai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('iLDa,iKCa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('ijCD,KiLj->KLCD', X_bbbb, v_xxvv, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('ijCD,KjLi->KLCD', X_bbbb, v_xvvx, optimize = einsum_type)
    sigma[cvee__bbbb] += ascontiguousarray(sigma_KLCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CVEE-CVEE", *cput1)

