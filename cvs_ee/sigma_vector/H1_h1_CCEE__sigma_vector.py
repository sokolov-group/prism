## h1 <- h1 coupling contributions
from . import logger, tools, ascontiguousarray

# CCAA <- CCEE
def compute_sigma_vector__H1__h1_h1__CCAA_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    ccaa__aaaa = mr_adc.h1.ccaa__aaaa
    ccaa__abab = mr_adc.h1.ccaa__abab
    ccaa__bbbb = mr_adc.h1.ccaa__bbbb 

    ## Indices
    cc_tril_ind = mr_adc.h1.cc_tril_ind 
    aa_tril_ind = mr_adc.h1.aa_tril_ind 

    ## Molecular Orbitals Energies
    e_extern = mr_adc.mo_energy.e
    
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa

    ## Two-electron integrals
    v_aeae = mr_adc.v2e.aeae
    v_aaaa = mr_adc.v2e.aaaa

    ## Amplitudes
    t1_aaee = mr_adc.t1.aaee

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    sigma_KLWU_aaaa =- 1/2 * einsum('KLab,UaWb->KLWU', X_aaaa, v_aeae, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,UbWa->KLWU', X_aaaa, v_aeae, optimize = einsum_type)
    sigma_KLWU_aaaa -= einsum('KLab,b,UWab->KLWU', X_aaaa, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += einsum('KLab,b,UWba->KLWU', X_aaaa, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Ux,Wxab->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Ux,Wxba->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Wx,Uxab->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Wx,Uxba->KLWU', X_aaaa, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,xyab,UxWy->KLWU', X_aaaa, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,xyab,UyWx->KLWU', X_aaaa, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uaxb,Wx->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Ubxa,Wx->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Waxb,Ux->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wbxa,Ux->KLWU', X_aaaa, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xayb,UWxy->KLWU', X_aaaa, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xayb,UWyx->KLWU', X_aaaa, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,b,Uxab,Wx->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,b,Wxba,Ux->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/6 * einsum('KLab,b,xyab,UWxy->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/6 * einsum('KLab,b,xyab,UWyx->KLWU', X_aaaa, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Ux,xyab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Ux,yxab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wx,xyab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wx,yxab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xy,Uxab,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xy,Uxba,Wy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xy,Wxab,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xy,Wxba,Uy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xy,xzab,UWyz->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xy,xzab,UWzy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xy,zxab,UWyz->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xy,zxab,UWzy->KLWU', X_aaaa, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Uxab,Wxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Uxab,Wyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Uxab,xyzw,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Uxba,Wxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/2 * einsum('KLab,Wxab,Uxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/2 * einsum('KLab,Wxba,Uxyz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wxba,Uyzx,zy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,Wxba,xyzw,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,UxWz,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Uxzw,Wwyz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Uxzy,Wz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,UyWz,xz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,UzWx,yz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,UzWy,xz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/4 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Wyzw,Uwxz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/4 * einsum('KLab,xyab,Wyzx,Uz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,xzwu,UWwyzu->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,xzwu,UWwzyu->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,xzyw,UWwz->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,xzyw,UWzw->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_aaaa += 1/12 * einsum('KLab,xyab,yzwu,UWwxzu->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_aaaa -= 1/12 * einsum('KLab,xyab,yzwu,UWwzxu->KLWU', X_aaaa, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_aaaa = sigma_KLWU_aaaa[:, :, aa_tril_ind[0], aa_tril_ind[1]]
    sigma[ccaa__aaaa] += ascontiguousarray(sigma_KLWU_aaaa[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    sigma_KLWU_abab  = einsum('KLab,UbWa->KLWU', X_abab, v_aeae, optimize = einsum_type)
    sigma_KLWU_abab += einsum('KLab,a,UWba->KLWU', X_abab, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab += einsum('KLab,b,UWba->KLWU', X_abab, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Ux,Wxab->KLWU', X_abab, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Wx,Uxba->KLWU', X_abab, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,xyab,UyWx->KLWU', X_abab, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,Ubxa,Wx->KLWU', X_abab, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,Waxb,Ux->KLWU', X_abab, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,xayb,UWxy->KLWU', X_abab, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/3 * einsum('KLab,xayb,UWyx->KLWU', X_abab, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,a,Uxba,Wx->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,a,Wxab,Ux->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,a,xyab,UWxy->KLWU', X_abab, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/3 * einsum('KLab,a,xyab,UWyx->KLWU', X_abab, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_abab, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,b,xyab,UWxy->KLWU', X_abab, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/3 * einsum('KLab,b,xyab,UWyx->KLWU', X_abab, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Ux,yxab,Wy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wx,xyab,Uy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xy,Uxba,Wy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xy,Wxab,Uy->KLWU', X_abab, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xy,xzab,UWyz->KLWU', X_abab, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xy,xzab,UWzy->KLWU', X_abab, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xy,zxab,UWyz->KLWU', X_abab, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xy,zxab,UWzy->KLWU', X_abab, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Uxba,Wxyz,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= einsum('KLab,Wxab,Uxyz,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,UyWz,xz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,UzWx,yz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/2 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,xzwu,UWwyzu->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,xzwu,UWwzyu->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/3 * einsum('KLab,xyab,xzyw,UWwz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,xzyw,UWzw->KLWU', X_abab, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,xyab,yzwu,UWwuxz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,xyab,yzwu,UWwuzx->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,xyab,yzwu,UWwxuz->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab += 1/6 * einsum('KLab,xyab,yzwu,UWwzux->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_abab -= 1/6 * einsum('KLab,xyab,yzwu,UWwzxu->KLWU', X_abab, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[ccaa__abab] += ascontiguousarray(sigma_KLWU_abab).reshape(-1)

    sigma_KLWU_bbbb =- 1/2 * einsum('KLab,UaWb->KLWU', X_bbbb, v_aeae, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,UbWa->KLWU', X_bbbb, v_aeae, optimize = einsum_type)
    sigma_KLWU_bbbb -= einsum('KLab,b,UWab->KLWU', X_bbbb, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += einsum('KLab,b,UWba->KLWU', X_bbbb, e_extern, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Ux,Wxab->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Ux,Wxba->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Wx,Uxab->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Wx,Uxba->KLWU', X_bbbb, h_aa, t1_aaee, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,xyab,UxWy->KLWU', X_bbbb, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,xyab,UyWx->KLWU', X_bbbb, t1_aaee, v_aaaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uaxb,Wx->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Ubxa,Wx->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Waxb,Ux->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wbxa,Ux->KLWU', X_bbbb, v_aeae, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xayb,UWxy->KLWU', X_bbbb, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xayb,UWyx->KLWU', X_bbbb, v_aeae, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,b,Uxab,Wx->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,b,Uxba,Wx->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,b,Wxab,Ux->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,b,Wxba,Ux->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/6 * einsum('KLab,b,xyab,UWxy->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/6 * einsum('KLab,b,xyab,UWyx->KLWU', X_bbbb, e_extern, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Ux,xyab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Ux,yxab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wx,xyab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wx,yxab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xy,Uxab,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xy,Uxba,Wy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xy,Wxab,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xy,Wxba,Uy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xy,xzab,UWyz->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xy,xzab,UWzy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xy,zxab,UWyz->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xy,zxab,UWzy->KLWU', X_bbbb, h_aa, t1_aaee, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Uxab,Wxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Uxab,Wyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Uxab,xyzw,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Uxba,Wxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uxba,Wyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Uxba,xyzw,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/2 * einsum('KLab,Wxab,Uxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wxab,Uyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,Wxab,xyzw,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/2 * einsum('KLab,Wxba,Uxyz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wxba,Uyzx,zy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,Wxba,xyzw,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,UxWz,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Uxzw,Wwyz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Uxzy,Wz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,UyWz,xz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Uyzw,Wwxz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Uyzx,Wz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,UzWx,yz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,UzWy,xz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Uzwx,Wzwy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Uzwx,Wzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Uzwy,Wzwx->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Uzwy,Wzxw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Wxzw,Uwyz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/4 * einsum('KLab,xyab,Wxzy,Uz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Wyzw,Uwxz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/4 * einsum('KLab,xyab,Wyzx,Uz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Wzwx,Uzwy->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Wzwx,Uzyw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,Wzwy,Uzwx->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,Wzwy,Uzxw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,xzwu,UWwyzu->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,xzwu,UWwzyu->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,xzyw,UWwz->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,xzyw,UWzw->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLWU_bbbb += 1/12 * einsum('KLab,xyab,yzwu,UWwxzu->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_bbbb -= 1/12 * einsum('KLab,xyab,yzwu,UWwzxu->KLWU', X_bbbb, t1_aaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLWU_bbbb = sigma_KLWU_bbbb[:, :, aa_tril_ind[0], aa_tril_ind[1]]
    sigma[ccaa__bbbb] += ascontiguousarray(sigma_KLWU_bbbb[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CCAA-CCEE", *cput1)

# CCEA <- CCEE
def compute_sigma_vector__H1__h1_h1__CCEA_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    ccea__aaaa = mr_adc.h1.ccea__aaaa
    ccea__abab = mr_adc.h1.ccea__abab
    ccea__abba = mr_adc.h1.ccea__abba
    ccea__bbbb = mr_adc.h1.ccea__bbbb 

    ## Indices
    cc_tril_ind = mr_adc.h1.cc_tril_ind 

    ## Molecular Orbitals Energies
    e_extern = mr_adc.mo_energy.e
    
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa
    h_ae = mr_adc.h1eff.ae

    ## Two-electron integrals
    v_aaae = mr_adc.v2e.aaae
    v_xxae = mr_adc.v2e.xxae
    v_xaex = mr_adc.v2e.xaex
    v_aaaa = mr_adc.v2e.aaaa
    v_aeee = mr_adc.v2e.aeee

    ## Amplitudes
    t1_ae = mr_adc.t1.ae 
    t1_aaae = mr_adc.t1.aaae

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    sigma_KLCW_aaaa  = einsum('KLCa,Wa->KLCW', X_aaaa, h_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLab,WaCb->KLCW', X_aaaa, v_aeee, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLab,WbCa->KLCW', X_aaaa, v_aeee, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_aaaa, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KiCa,iLWa->KLCW', X_aaaa, v_xxae, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('LiCa,KWai->KLCW', X_aaaa, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('LiCa,iKWa->KLCW', X_aaaa, v_xxae, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('LiCa,KWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,a,Wa->KLCW', X_aaaa, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xa,Wx->KLCW', X_aaaa, h_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,Wx,xa->KLCW', X_aaaa, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_aaaa, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xyWa,xy->KLCW', X_aaaa, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xyza,Wyzx->KLCW', X_aaaa, v_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/4 * einsum('KLab,xaCb,Wx->KLCW', X_aaaa, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/4 * einsum('KLab,xbCa,Wx->KLCW', X_aaaa, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_aaaa, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_aaaa, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('LiCa,iKxa,Wx->KLCW', X_aaaa, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_aaaa, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,a,xWya,xy->KLCW', X_aaaa, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,a,xa,Wx->KLCW', X_aaaa, e_extern, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,a,xyza,Wzyx->KLCW', X_aaaa, e_extern, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,Wx,yxza,zy->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xy,xWza,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xy,xa,Wy->KLCW', X_aaaa, h_aa, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xy,xzwa,Wwzy->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xy,zWxa,yz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xy,zwxa,Wywz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xy,zxwa,Wwyz->KLCW', X_aaaa, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_aaaa, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_aaaa, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xa,xyzw,Wzyw->KLCW', X_aaaa, t1_ae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,xwuv,Wzuywv->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvwx->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvxw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuwvx->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/3 * einsum('KLCa,xyza,ywuv,Wzuwxv->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxvw->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxwv->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KLCa,xyza,ywxu,Wzwu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KLCa,xyza,zwuv,Wwvyxu->KLCW', X_aaaa, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[ccea__aaaa] += ascontiguousarray(sigma_KLCW_aaaa[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    sigma_KLCW_abab  = einsum('KiCa,LWai->KLCW', X_aaaa, v_xaex, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,Wa->KLCW', X_abab, h_ae, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLab,WbCa->KLCW', X_abab, v_aeee, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KiCa,LWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KiCa,iLWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('iLCa,iKWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,a,Wa->KLCW', X_abab, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xa,Wx->KLCW', X_abab, h_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,Wx,xa->KLCW', X_abab, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xyWa,xy->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xyza,Wyzx->KLCW', X_abab, v_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLab,xbCa,Wx->KLCW', X_abab, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('iLCa,iKxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,a,xWya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,a,xa,Wx->KLCW', X_abab, e_extern, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,a,xyza,Wzyx->KLCW', X_abab, e_extern, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,Wx,yxza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xy,xWza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xy,xa,Wy->KLCW', X_abab, h_aa, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xy,xzwa,Wwzy->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xy,zWxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xy,zwxa,Wywz->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xy,zxwa,Wwyz->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xa,xyzw,Wzyw->KLCW', X_abab, t1_ae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,xwuv,Wzuywv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvwx->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuwvx->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/3 * einsum('KLCa,xyza,ywuv,Wzuwxv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxvw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxwv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KLCa,xyza,ywxu,Wzwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KLCa,xyza,zwuv,Wwvyxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[ccea__abab] += ascontiguousarray(sigma_KLCW_abab).reshape(-1)

    sigma_KLCW_abba =- einsum('KLaC,Wa->KLCW', X_abab, h_ae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLab,WaCb->KLCW', X_abab, v_aeee, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KiaC,iLWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('iLaC,KWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_abba += einsum('iLaC,iKWa->KLCW', X_abab, v_xxae, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('LiCa,KWai->KLCW', X_bbbb, v_xaex, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,a,Wa->KLCW', X_abab, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xa,Wx->KLCW', X_abab, h_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,Wx,xa->KLCW', X_abab, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,Wxya,yx->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xyWa,xy->KLCW', X_abab, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xyza,Wyzx->KLCW', X_abab, v_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLab,xaCb,Wx->KLCW', X_abab, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KiaC,iLxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('iLaC,iKxa,Wx->KLCW', X_abab, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_bbbb, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,a,Wxya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,a,xWya,xy->KLCW', X_abab, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,a,xa,Wx->KLCW', X_abab, e_extern, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,a,xyza,Wzyx->KLCW', X_abab, e_extern, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,Wx,xyza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,Wx,yxza,zy->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xy,Wxza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xy,Wzxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xy,xWza,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xy,xa,Wy->KLCW', X_abab, h_aa, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xy,xzwa,Wwzy->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xy,zWxa,yz->KLCW', X_abab, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xy,zwxa,Wywz->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xy,zxwa,Wwyz->KLCW', X_abab, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,Wxya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,Wxya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xWya,xzwu,ywzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= einsum('KLaC,xWya,yzwu,xwzu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xa,Wxyz,yz->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xa,Wyzx,zy->KLCW', X_abab, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xa,xyzw,Wzyw->KLCW', X_abab, t1_ae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wwux,zwuy->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wwuy,zwxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xyza,Wwzu,yxwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wxwu,zuyw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,Wxwy,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xyza,Wywu,zuxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += einsum('KLaC,xyza,Wywx,zw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,xwuv,Wzuywv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/6 * einsum('KLaC,xyza,ywuv,Wzuvwx->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/6 * einsum('KLaC,xyza,ywuv,Wzuvxw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/6 * einsum('KLaC,xyza,ywuv,Wzuwvx->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/3 * einsum('KLaC,xyza,ywuv,Wzuwxv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/6 * einsum('KLaC,xyza,ywuv,Wzuxvw->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/6 * einsum('KLaC,xyza,ywuv,Wzuxwv->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KLaC,xyza,ywxu,Wzwu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_abba += 1/2 * einsum('KLaC,xyza,zwuv,Wwvyxu->KLCW', X_abab, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[ccea__abba] += ascontiguousarray(sigma_KLCW_abba).reshape(-1)

    sigma_KLCW_bbbb  = einsum('iKaC,LWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('iLaC,KWai->KLCW', X_abab, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,Wa->KLCW', X_bbbb, h_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLab,WaCb->KLCW', X_bbbb, v_aeee, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLab,WbCa->KLCW', X_bbbb, v_aeee, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KiCa,LWai->KLCW', X_bbbb, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KiCa,iLWa->KLCW', X_bbbb, v_xxae, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('LiCa,KWai->KLCW', X_bbbb, v_xaex, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('LiCa,iKWa->KLCW', X_bbbb, v_xxae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('iKaC,Lxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('iLaC,Kxai,Wx->KLCW', X_abab, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,a,Wa->KLCW', X_bbbb, e_extern, t1_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xa,Wx->KLCW', X_bbbb, h_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,Wx,xa->KLCW', X_bbbb, h_aa, t1_ae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,Wxya,yx->KLCW', X_bbbb, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xyWa,xy->KLCW', X_bbbb, v_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xyza,Wyzx->KLCW', X_bbbb, v_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/4 * einsum('KLab,xaCb,Wx->KLCW', X_bbbb, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/4 * einsum('KLab,xbCa,Wx->KLCW', X_bbbb, v_aeee, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_bbbb, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('LiCa,Kxai,Wx->KLCW', X_bbbb, v_xaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('LiCa,iKxa,Wx->KLCW', X_bbbb, v_xxae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,a,Wxya,xy->KLCW', X_bbbb, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,a,xWya,xy->KLCW', X_bbbb, e_extern, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,a,xa,Wx->KLCW', X_bbbb, e_extern, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,a,xyza,Wzyx->KLCW', X_bbbb, e_extern, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,Wx,xyza,zy->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,Wx,yxza,zy->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xy,Wxza,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xy,Wzxa,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xy,xWza,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xy,xa,Wy->KLCW', X_bbbb, h_aa, t1_ae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xy,xzwa,Wwzy->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xy,zWxa,yz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xy,zwxa,Wywz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xy,zxwa,Wwyz->KLCW', X_bbbb, h_aa, t1_aaae, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,Wxya,xzwu,ywzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,Wxya,yzwu,xwzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xWya,xzwu,ywzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KLCa,xWya,yzwu,xwzu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xa,Wxyz,yz->KLCW', X_bbbb, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xa,Wyzx,zy->KLCW', X_bbbb, t1_ae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xa,xyzw,Wzyw->KLCW', X_bbbb, t1_ae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wwux,zwuy->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wwuy,zwxu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xyza,Wwzu,yxwu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wxwu,zuyw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,Wxwy,zw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xyza,Wywu,zuxw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KLCa,xyza,Wywx,zw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,xwuv,Wzuywv->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvwx->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuvxw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuwvx->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/3 * einsum('KLCa,xyza,ywuv,Wzuwxv->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxvw->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/6 * einsum('KLCa,xyza,ywuv,Wzuxwv->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KLCa,xyza,ywxu,Wzwu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KLCa,xyza,zwuv,Wwvyxu->KLCW', X_bbbb, t1_aaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[ccea__bbbb] += ascontiguousarray(sigma_KLCW_bbbb[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CCEA-CCEE", *cput1)

# CCEE <- CCEE
def compute_sigma_vector__H1__h1_h1__CCEE_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    ccee__aaaa = mr_adc.h1.ccee__aaaa
    ccee__abab = mr_adc.h1.ccee__abab
    ccee__bbbb = mr_adc.h1.ccee__bbbb 

    ## Indices
    cc_tril_ind = mr_adc.h1.cc_tril_ind 
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Two-electron integrals
    v_xxxx = mr_adc.v2e.xxxx
    v_xxee = mr_adc.v2e.xxee
    v_xeex = mr_adc.v2e.xeex
    v_eeee = mr_adc.v2e.eeee

    sigma_KLCD_aaaa  = 1/2 * einsum('KLab,CaDb->KLCD', X_aaaa, v_eeee, optimize = einsum_type)
    sigma_KLCD_aaaa -= 1/2 * einsum('KLab,CbDa->KLCD', X_aaaa, v_eeee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiCa,iLDa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiDa,iLCa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiCa,KDai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiCa,iKDa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiDa,KCai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiDa,iKCa->KLCD', X_aaaa, v_xxee, optimize = einsum_type)
    sigma_KLCD_aaaa += 1/2 * einsum('ijCD,KiLj->KLCD', X_aaaa, v_xxxx, optimize = einsum_type)
    sigma_KLCD_aaaa -= 1/2 * einsum('ijCD,KjLi->KLCD', X_aaaa, v_xxxx, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('LiCa,KDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('LiDa,KCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_aaaa = sigma_KLCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]
    sigma[ccee__aaaa] += ascontiguousarray(sigma_KLCD_aaaa[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    sigma_KLCD_abab  = einsum('KiCa,LDai->KLCD', X_aaaa, v_xeex, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KLab,CaDb->KLCD', X_abab, v_eeee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KiCa,LDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiCa,iLDa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiaD,iLCa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('iLCa,iKDa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('iLaD,KCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('iLaD,iKCa->KLCD', X_abab, v_xxee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijCD,KiLj->KLCD', X_abab, v_xxxx, optimize = einsum_type)
    sigma_KLCD_abab += einsum('LiDa,KCai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma[ccee__abab] += ascontiguousarray(sigma_KLCD_abab).reshape(-1)

    sigma_KLCD_bbbb  = einsum('iKaC,LDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('iKaD,LCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('iLaC,KDai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('iLaD,KCai->KLCD', X_abab, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += 1/2 * einsum('KLab,CaDb->KLCD', X_bbbb, v_eeee, optimize = einsum_type)
    sigma_KLCD_bbbb -= 1/2 * einsum('KLab,CbDa->KLCD', X_bbbb, v_eeee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiCa,LDai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiCa,iLDa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiDa,iLCa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('LiCa,KDai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('LiCa,iKDa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('LiDa,KCai->KLCD', X_bbbb, v_xeex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('LiDa,iKCa->KLCD', X_bbbb, v_xxee, optimize = einsum_type)
    sigma_KLCD_bbbb += 1/2 * einsum('ijCD,KiLj->KLCD', X_bbbb, v_xxxx, optimize = einsum_type)
    sigma_KLCD_bbbb -= 1/2 * einsum('ijCD,KjLi->KLCD', X_bbbb, v_xxxx, optimize = einsum_type)
    sigma_KLCD_bbbb = sigma_KLCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]
    sigma[ccee__bbbb] += ascontiguousarray(sigma_KLCD_bbbb[cc_tril_ind[0], cc_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CCEE-CCEE", *cput1)

# CAEE <- CCEE
def compute_sigma_vector__H1__h1_h1__CAEE_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caee__aaaa = mr_adc.h1.caee__aaaa
    caee__abab = mr_adc.h1.caee__abab
    caee__baba = mr_adc.h1.caee__baba
    caee__bbbb = mr_adc.h1.caee__bbbb 

    ## Indices
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Molecular Orbitals Energies
    e_cvs = mr_adc.mo_energy.x
    
    ## One-electron integrals
    h_xa = mr_adc.h1eff.xa
    h_aa = mr_adc.h1eff.aa

    ## Two-electron integrals
    v_xxxa = mr_adc.v2e.xxxa
    v_xaaa = mr_adc.v2e.xaaa
    v_xaee = mr_adc.v2e.xaee
    v_xeea = mr_adc.v2e.xeea
    v_aaaa = mr_adc.v2e.aaaa

    ## Amplitudes
    t1_xa = mr_adc.t1.xa
    t1_xaaa = mr_adc.t1.xaaa

    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    sigma_KWCD_aaaa =- 1/2 * einsum('KiCD,ix,Wx->KWCD', X_aaaa, h_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ixyz,Wyxz->KWCD', X_aaaa, v_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_aaaa, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_aaaa, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_aaaa, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiDa,ixCa,Wx->KWCD', X_aaaa, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/4 * einsum('ijCD,iKjx,Wx->KWCD', X_aaaa, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/4 * einsum('ijCD,jKix,Wx->KWCD', X_aaaa, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,i,ix,Wx->KWCD', X_aaaa, e_cvs, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,i,ixyz,Wxyz->KWCD', X_aaaa, e_cvs, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,xy,ix,Wy->KWCD', X_aaaa, h_aa, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,xy,ixzw,Wyzw->KWCD', X_aaaa, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,xy,izwx,Wzwy->KWCD', X_aaaa, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,xy,izxw,Wzyw->KWCD', X_aaaa, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ix,xyzw,Wzyw->KWCD', X_aaaa, t1_xa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/2 * einsum('KiCD,ixyz,xwuv,Wwvyzu->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvwz->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvzw->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuwvz->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/3 * einsum('KiCD,ixyz,ywuv,Wxuwzv->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzvw->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzwv->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ixyz,ywzu,Wxwu->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_aaaa -= 1/2 * einsum('KiCD,ixyz,zwuv,Wxuywv->KWCD', X_aaaa, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caee__aaaa] += ascontiguousarray(sigma_KWCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    sigma_KWCD_abab  = 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_aaaa, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ix,Wx->KWCD', X_abab, h_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ixyz,Wyxz->KWCD', X_abab, v_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_abab, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiaD,ixCa,Wx->KWCD', X_abab, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('ijCD,iKjx,Wx->KWCD', X_abab, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,i,ix,Wx->KWCD', X_abab, e_cvs, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,i,ixyz,Wxyz->KWCD', X_abab, e_cvs, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,xy,ix,Wy->KWCD', X_abab, h_aa, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,xy,ixzw,Wyzw->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,xy,izwx,Wzwy->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,xy,izxw,Wzyw->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ix,xyzw,Wzyw->KWCD', X_abab, t1_xa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/2 * einsum('KiCD,ixyz,xwuv,Wwvyzu->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvwz->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvzw->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuwvz->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/3 * einsum('KiCD,ixyz,ywuv,Wxuwzv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzvw->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzwv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ixyz,ywzu,Wxwu->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_abab -= 1/2 * einsum('KiCD,ixyz,zwuv,Wxuywv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caee__abab] += ascontiguousarray(sigma_KWCD_abab).reshape(-1)

    sigma_KWCD_baba =- 1/2 * einsum('iKDC,ix,Wx->KWCD', X_abab, h_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,ixyz,Wyxz->KWCD', X_abab, v_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDa,ixCa,Wx->KWCD', X_abab, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('iKaC,iaDx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKaC,ixDa,Wx->KWCD', X_abab, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('ijDC,jKix,Wx->KWCD', X_abab, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_bbbb, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('iKDC,i,ix,Wx->KWCD', X_abab, e_cvs, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('iKDC,i,ixyz,Wxyz->KWCD', X_abab, e_cvs, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,xy,ix,Wy->KWCD', X_abab, h_aa, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('iKDC,xy,ixzw,Wyzw->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,xy,izwx,Wzwy->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,xy,izxw,Wzyw->KWCD', X_abab, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,ix,xyzw,Wzyw->KWCD', X_abab, t1_xa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/2 * einsum('iKDC,ixyz,xwuv,Wwvyzu->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/6 * einsum('iKDC,ixyz,ywuv,Wxuvwz->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/6 * einsum('iKDC,ixyz,ywuv,Wxuvzw->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/6 * einsum('iKDC,ixyz,ywuv,Wxuwvz->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/3 * einsum('iKDC,ixyz,ywuv,Wxuwzv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/6 * einsum('iKDC,ixyz,ywuv,Wxuzvw->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba += 1/6 * einsum('iKDC,ixyz,ywuv,Wxuzwv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,ixyz,ywzu,Wxwu->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_baba -= 1/2 * einsum('iKDC,ixyz,zwuv,Wxuywv->KWCD', X_abab, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caee__baba] += ascontiguousarray(sigma_KWCD_baba).reshape(-1)

    sigma_KWCD_bbbb  = 1/2 * einsum('iKaC,iaDx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('iKaD,iaCx,Wx->KWCD', X_abab, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ix,Wx->KWCD', X_bbbb, h_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ixyz,Wyxz->KWCD', X_bbbb, v_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCa,iaDx,Wx->KWCD', X_bbbb, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCa,ixDa,Wx->KWCD', X_bbbb, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiDa,iaCx,Wx->KWCD', X_bbbb, v_xeea, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiDa,ixCa,Wx->KWCD', X_bbbb, v_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/4 * einsum('ijCD,iKjx,Wx->KWCD', X_bbbb, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/4 * einsum('ijCD,jKix,Wx->KWCD', X_bbbb, v_xxxa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,i,ix,Wx->KWCD', X_bbbb, e_cvs, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,i,ixyz,Wxyz->KWCD', X_bbbb, e_cvs, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,xy,ix,Wy->KWCD', X_bbbb, h_aa, t1_xa, rdm_ca, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,xy,ixzw,Wyzw->KWCD', X_bbbb, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,xy,izwx,Wzwy->KWCD', X_bbbb, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,xy,izxw,Wzyw->KWCD', X_bbbb, h_aa, t1_xaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ix,xyzw,Wzyw->KWCD', X_bbbb, t1_xa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/2 * einsum('KiCD,ixyz,xwuv,Wwvyzu->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvwz->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuvzw->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuwvz->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/3 * einsum('KiCD,ixyz,ywuv,Wxuwzv->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzvw->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb += 1/6 * einsum('KiCD,ixyz,ywuv,Wxuzwv->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ixyz,ywzu,Wxwu->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCD_bbbb -= 1/2 * einsum('KiCD,ixyz,zwuv,Wxuywv->KWCD', X_bbbb, t1_xaaa, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caee__bbbb] += ascontiguousarray(sigma_KWCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAEE-CCEE", *cput1)

# CAAA <- CCEE
def compute_sigma_vector__H1__h1_h1__CAAA_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caaa__aaaa = mr_adc.h1.caaa__aaaa
    caaa__abab = mr_adc.h1.caaa__abab
    caaa__baba = mr_adc.h1.caaa__baba
    caaa__bbbb = mr_adc.h1.caaa__bbbb 

    ## Indices
    aa_tril_ind = mr_adc.h1.aa_tril_ind 

    ## Molecular Orbitals Energies
    e_cvs = mr_adc.mo_energy.x
    e_extern = mr_adc.mo_energy.e
 
    ## One-electron integrals
    h_aa = mr_adc.h1eff.aa
 
    ## Two-electron integrals
    v_xeae = mr_adc.v2e.xeae
    v_aaaa = mr_adc.v2e.aaaa
  
    ## Amplitudes
    t1_xaee = mr_adc.t1.xaee
  
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    sigma_KWUV_aaaa =- 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,iaVb,UW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,iaxb,UVWx->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,iaxb,UVxW->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ibVa,UW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ibxa,UVWx->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ibxa,UVxW->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ibVa,UW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ibxa,UVWx->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ibxa,UVxW->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iVab,UW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,b,ixab,UVWx->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,b,ixab,UVxW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,b,ixba,UVxW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,i,iVab,UW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,i,iVba,UW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,i,ixab,UVWx->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,i,ixab,UVxW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,i,ixba,UVWx->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,i,ixba,UVxW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,Vx,ixab,UW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,Vx,ixba,UW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,xy,ixab,UVWy->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,xy,ixab,UVyW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixab,UyVx,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixab,Vxyz,UzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixab,xyzw,UVzWyw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixab,xyzw,UVzyWw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/4 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/12 * einsum('Kiab,ixba,xyzw,UVzWyw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/12 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,a,iVba,UW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,a,ixba,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,a,ixba,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,b,ixba,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,i,iVba,UW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,i,ixba,UVWx->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,i,ixba,UVxW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,Vx,ixba,UW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/2 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_aaaa -= 1/6 * einsum('Kiab,ixba,xyzw,UVzWyw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_aaaa += 1/6 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caaa__aaaa] += ascontiguousarray(sigma_KWUV_aaaa[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1)

    sigma_KWUV_abab =- 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,iaxb,UVWx->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,iaxb,UVxW->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_aaaa, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ibxa,UVWx->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ibxa,UVxW->KWUV', X_aaaa, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,ibUa,VW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ibxa,UVWx->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/3 * einsum('Kiab,ibxa,UVxW->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,b,ixab,UVWx->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,b,ixab,UVxW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/3 * einsum('Kiab,b,ixba,UVxW->KWUV', X_aaaa, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,i,ixab,UVWx->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,i,ixab,UVxW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,i,ixba,UVWx->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,i,ixba,UVxW->KWUV', X_aaaa, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,xy,ixab,UVWy->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,xy,ixab,UVyW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_aaaa, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixab,xyzw,UVzWwy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixab,xyzw,UVzwWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixab,xyzw,UVzwyW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixab,xyzw,UVzyWw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixab,xyzw,UVzywW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixba,xyzw,UVzWwy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixba,xyzw,UVzwWy->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixba,xyzw,UVzwyW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/12 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/12 * einsum('Kiab,ixba,xyzw,UVzywW->KWUV', X_aaaa, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,a,iUba,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,a,ixba,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/3 * einsum('Kiab,a,ixba,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/3 * einsum('Kiab,b,ixba,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,i,iUba,VW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,i,ixba,UVWx->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,i,ixba,UVxW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,Ux,ixba,VW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_abab -= 1/2 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/3 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,xyzw,UVzWwy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,xyzw,UVzwWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,xyzw,UVzwyW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab += 1/6 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_abab -= 1/6 * einsum('Kiab,ixba,xyzw,UVzywW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caaa__abab] += ascontiguousarray(sigma_KWUV_abab).reshape(-1)

    sigma_KWUV_baba  = 1/2 * einsum('iKab,iaUb,VW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,iaxb,UVWx->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/3 * einsum('iKab,iaxb,UVxW->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,iaxb,UVWx->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,iaxb,UVxW->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ibxa,UVWx->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ibxa,UVxW->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('iKab,a,iUab,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,a,ixab,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/3 * einsum('iKab,a,ixab,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('iKab,b,iUab,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,b,ixab,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/3 * einsum('iKab,b,ixab,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('iKab,i,iUab,VW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('iKab,i,ixab,UVWx->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('iKab,i,ixab,UVxW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('iKab,Ux,ixab,VW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('iKab,xy,ixab,UVWy->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('iKab,xy,ixab,UVyW->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('iKab,ixab,UxVy,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('iKab,ixab,Uxyz,VzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('iKab,ixab,Uyzx,VyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('iKab,ixab,Uyzx,VyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('iKab,ixab,Vyzx,UyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('iKab,ixab,Vyzx,UyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,ixab,xyzw,UVzWwy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,ixab,xyzw,UVzwWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,ixab,xyzw,UVzwyW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('iKab,ixab,xyzw,UVzyWw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('iKab,ixab,xyzw,UVzywW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,b,ixab,UVWx->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/3 * einsum('Kiab,b,ixab,UVxW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/3 * einsum('Kiab,b,ixba,UVxW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,i,ixab,UVWx->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,i,ixab,UVxW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,i,ixba,UVWx->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,i,ixba,UVxW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,xy,ixab,UVWy->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,xy,ixab,UVyW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/6 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixab,xyzw,UVzWwy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixab,xyzw,UVzwWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixab,xyzw,UVzwyW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixab,xyzw,UVzyWw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixab,xyzw,UVzywW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_baba -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/6 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixba,xyzw,UVzWwy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixba,xyzw,UVzwWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixba,xyzw,UVzwyW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba += 1/12 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_baba -= 1/12 * einsum('Kiab,ixba,xyzw,UVzywW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caaa__baba] += ascontiguousarray(sigma_KWUV_baba).reshape(-1)

    sigma_KWUV_bbbb  = 1/2 * einsum('iKab,iaUb,VW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,iaVb,UW->KWUV', X_abab, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,iaxb,UVWx->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,iaxb,UVxW->KWUV', X_abab, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,iaUb,VW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,iaVb,UW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,iaxb,UVWx->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,iaxb,UVxW->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ibUa,VW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ibVa,UW->KWUV', X_bbbb, v_xeae, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ibxa,UVWx->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ibxa,UVxW->KWUV', X_bbbb, v_xeae, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,a,iUab,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,a,iVab,UW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,a,ixab,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,a,ixab,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,b,iUab,VW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,b,iVab,UW->KWUV', X_abab, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,b,ixab,UVWx->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,b,ixab,UVxW->KWUV', X_abab, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,i,iUab,VW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,i,iVab,UW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,i,ixab,UVWx->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,i,ixab,UVxW->KWUV', X_abab, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,Ux,ixab,VW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,Vx,ixab,UW->KWUV', X_abab, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,xy,ixab,UVWy->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,xy,ixab,UVyW->KWUV', X_abab, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,ixab,UxVy,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('iKab,ixab,Uxyz,VzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,ixab,UyVx,Wy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,ixab,Uyzx,VyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,ixab,Uyzx,VyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('iKab,ixab,Vxyz,UzWy->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,ixab,Vyzx,UyWz->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,ixab,Vyzx,UyzW->KWUV', X_abab, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('iKab,ixab,xyzw,UVzWyw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('iKab,ixab,xyzw,UVzyWw->KWUV', X_abab, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,b,iUab,VW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,b,iUba,VW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/2 * einsum('Kiab,b,iVab,UW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/2 * einsum('Kiab,b,iVba,UW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('Kiab,b,ixab,UVWx->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('Kiab,b,ixab,UVxW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/6 * einsum('Kiab,b,ixba,UVWx->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/6 * einsum('Kiab,b,ixba,UVxW->KWUV', X_bbbb, e_extern, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,i,iUab,VW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,i,iUba,VW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,i,iVab,UW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,i,iVba,UW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,i,ixab,UVWx->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,i,ixab,UVxW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,i,ixba,UVWx->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,i,ixba,UVxW->KWUV', X_bbbb, e_cvs, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,Ux,ixab,VW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,Ux,ixba,VW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,Vx,ixab,UW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,Vx,ixba,UW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,xy,ixab,UVWy->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,xy,ixab,UVyW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,xy,ixba,UVWy->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,xy,ixba,UVyW->KWUV', X_bbbb, h_aa, t1_xaee, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixab,UxVy,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixab,Uxyz,VzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixab,UyVx,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,Uyzx,VyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,Uyzx,VyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixab,Vxyz,UzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,Vyzx,UyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,Vyzx,UyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixab,xyzw,UVzWyw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixab,xyzw,UVzyWw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixba,UxVy,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/4 * einsum('Kiab,ixba,Uxyz,VzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixba,UyVx,Wy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ca, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,Uyzx,VyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,Uyzx,VyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/4 * einsum('Kiab,ixba,Vxyz,UzWy->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,Vyzx,UyWz->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,Vyzx,UyzW->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWUV_bbbb -= 1/12 * einsum('Kiab,ixba,xyzw,UVzWyw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWUV_bbbb += 1/12 * einsum('Kiab,ixba,xyzw,UVzyWw->KWUV', X_bbbb, t1_xaee, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caaa__bbbb] += ascontiguousarray(sigma_KWUV_bbbb[:, :, aa_tril_ind[0], aa_tril_ind[1]]).reshape(-1)
 
    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAAA-CCEE", *cput1)

# CAEA <- CCEE
def compute_sigma_vector__H1__h1_h1__CAEA_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    caea__aaaa = mr_adc.h1.caea__aaaa
    caea__abab = mr_adc.h1.caea__abab
    caea__baab = mr_adc.h1.caea__baab
    caea__bbbb = mr_adc.h1.caea__bbbb
    caea__baba = mr_adc.h1.caea__baba
    caea__abba = mr_adc.h1.caea__abba 
 
    ## Molecular Orbitals Energies
    e_cvs = mr_adc.mo_energy.x
    e_extern = mr_adc.mo_energy.e
 
    ## One-electron integrals
    h_xe = mr_adc.h1eff.xe
    h_aa = mr_adc.h1eff.aa
 
    ## Two-electron integrals
    v_xxxe = mr_adc.v2e.xxxe
    v_xaae = mr_adc.v2e.xaae
    v_xeaa = mr_adc.v2e.xeaa
    v_aaaa = mr_adc.v2e.aaaa
    v_xeee = mr_adc.v2e.xeee
  
    ## Amplitudes
    t1_xe = mr_adc.t1.xe
    t1_xaae = mr_adc.t1.xaae
    t1_xaea = mr_adc.t1.xaea
    
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    sigma_KWCU_aaaa  = 1/2 * einsum('KiCa,ia,UW->KWCU', X_aaaa, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_aaaa, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_aaaa, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_aaaa, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,UxWy->KWCU', X_aaaa, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_aaaa, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_aaaa, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_aaaa, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/4 * einsum('ijCa,iKja,UW->KWCU', X_aaaa, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/4 * einsum('ijCa,jKia,UW->KWCU', X_aaaa, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ia,UW->KWCU', X_abab, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_abab, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_abab, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_abab, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_abab, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_aaaa, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_aaaa, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_aaaa, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_aaaa, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,a,ixya,UyWx->KWCU', X_aaaa, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_aaaa, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_aaaa, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_aaaa, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_aaaa, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_aaaa, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,i,ixya,UyWx->KWCU', X_aaaa, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_aaaa, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_abab, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_abab, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_abab, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_abab, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/3 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa += 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/3 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_aaaa -= 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__aaaa] += ascontiguousarray(sigma_KWCU_aaaa).reshape(-1)

    sigma_KWCU_abab  = 1/2 * einsum('KiCa,ia,UW->KWCU', X_aaaa, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_aaaa, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_aaaa, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,ixya,UxWy->KWCU', X_aaaa, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_aaaa, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_aaaa, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_aaaa, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/4 * einsum('ijCa,iKja,UW->KWCU', X_aaaa, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/4 * einsum('ijCa,jKia,UW->KWCU', X_aaaa, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ia,UW->KWCU', X_abab, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_abab, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_abab, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_abab, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('Kiab,ibCa,UW->KWCU', X_abab, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('ijCa,iKja,UW->KWCU', X_abab, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_aaaa, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_aaaa, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_aaaa, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,a,ixya,UyWx->KWCU', X_aaaa, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_aaaa, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_aaaa, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_aaaa, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_aaaa, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,i,ixya,UyWx->KWCU', X_aaaa, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_aaaa, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_aaaa, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_aaaa, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_aaaa, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/3 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/3 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_aaaa, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_abab, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_abab, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_abab, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_abab, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab -= 1/6 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abab += 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__abab] += ascontiguousarray(sigma_KWCU_abab).reshape(-1)

    sigma_KWCU_abba  = 1/2 * einsum('KiaC,ixUa,Wx->KWCU', X_abab, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,i,iUxa,Wx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/3 * einsum('KiaC,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/3 * einsum('KiaC,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/2 * einsum('KiaC,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/2 * einsum('KiaC,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/3 * einsum('KiaC,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/3 * einsum('KiaC,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,xzwu,UywWuz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,xzwu,UywuWz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,xzwu,UywuzW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,xzwu,UywzuW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,yzwu,UzuWwx->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,yzwu,UzuwWx->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,yzwu,UzuwxW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba -= 1/6 * einsum('KiaC,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_abba += 1/6 * einsum('KiaC,ixya,yzwu,UzuxwW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__abba] += ascontiguousarray(sigma_KWCU_abba).reshape(-1)

    sigma_KWCU_baab  = 1/2 * einsum('iKCa,ixUa,Wx->KWCU', X_abab, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('iKCa,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('iKCa,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('iKCa,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('iKCa,i,iUxa,Wx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/3 * einsum('iKCa,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('iKCa,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('iKCa,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/3 * einsum('iKCa,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('iKCa,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/2 * einsum('iKCa,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/2 * einsum('iKCa,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/3 * einsum('iKCa,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/3 * einsum('iKCa,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,xzwu,UywWuz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,xzwu,UywuWz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,xzwu,UywuzW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,xzwu,UywzuW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,yzwu,UzuWwx->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,yzwu,UzuwWx->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,yzwu,UzuwxW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab -= 1/6 * einsum('iKCa,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baab += 1/6 * einsum('iKCa,ixya,yzwu,UzuxwW->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__baab] += ascontiguousarray(sigma_KWCU_baab).reshape(-1)

    sigma_KWCU_baba  = 1/2 * einsum('iKaC,ia,UW->KWCU', X_abab, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,iaUx,Wx->KWCU', X_abab, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,iaxy,UyWx->KWCU', X_abab, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,ixUa,Wx->KWCU', X_abab, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKab,iaCb,UW->KWCU', X_abab, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('ijaC,jKia,UW->KWCU', X_abab, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ia,UW->KWCU', X_bbbb, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_bbbb, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_bbbb, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,ixya,UxWy->KWCU', X_bbbb, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_bbbb, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_bbbb, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_bbbb, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/4 * einsum('ijCa,iKja,UW->KWCU', X_bbbb, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/4 * einsum('ijCa,jKia,UW->KWCU', X_bbbb, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,a,iUax,Wx->KWCU', X_abab, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,a,iUxa,Wx->KWCU', X_abab, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,a,ia,UW->KWCU', X_abab, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,a,ixay,UyWx->KWCU', X_abab, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,i,iUax,Wx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,i,iUxa,Wx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,i,ia,UW->KWCU', X_abab, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,i,ixay,UyWx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,Ux,ixya,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,xy,iUxa,Wy->KWCU', X_abab, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,xy,ixaz,UzWy->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,xy,izax,UyWz->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,iUax,xyzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,iUxa,xyzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('iKaC,ixay,xzwu,UywWzu->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,ixay,yzwu,UzuWxw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('iKaC,ixya,Uxzw,Wzyw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,ixya,xzwu,UywWzu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('iKaC,ixya,yzwu,UzuWxw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('iKaC,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_bbbb, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_bbbb, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_bbbb, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,a,ixya,UyWx->KWCU', X_bbbb, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_bbbb, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_bbbb, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_bbbb, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_bbbb, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,i,ixya,UyWx->KWCU', X_bbbb, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_bbbb, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/3 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba += 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/3 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_baba -= 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__baba] += ascontiguousarray(sigma_KWCU_baba).reshape(-1)

    sigma_KWCU_bbbb  = 1/2 * einsum('iKaC,ia,UW->KWCU', X_abab, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,iaUx,Wx->KWCU', X_abab, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,iaxy,UyWx->KWCU', X_abab, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('iKaC,ixya,UxWy->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('iKaC,ixya,UxyW->KWCU', X_abab, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKab,iaCb,UW->KWCU', X_abab, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('ijaC,jKia,UW->KWCU', X_abab, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ia,UW->KWCU', X_bbbb, h_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iaUx,Wx->KWCU', X_bbbb, v_xeaa, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iaxy,UyWx->KWCU', X_bbbb, v_xeaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixUa,Wx->KWCU', X_bbbb, v_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,UxWy->KWCU', X_bbbb, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,UxyW->KWCU', X_bbbb, v_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/4 * einsum('Kiab,iaCb,UW->KWCU', X_bbbb, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/4 * einsum('Kiab,ibCa,UW->KWCU', X_bbbb, v_xeee, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/4 * einsum('ijCa,iKja,UW->KWCU', X_bbbb, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/4 * einsum('ijCa,jKia,UW->KWCU', X_bbbb, v_xxxe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,a,iUax,Wx->KWCU', X_abab, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,a,ia,UW->KWCU', X_abab, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,a,ixay,UyWx->KWCU', X_abab, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('iKaC,a,ixya,UyWx->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('iKaC,a,ixya,UyxW->KWCU', X_abab, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,i,iUax,Wx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,i,ia,UW->KWCU', X_abab, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,i,ixay,UyWx->KWCU', X_abab, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('iKaC,i,ixya,UyWx->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('iKaC,i,ixya,UyxW->KWCU', X_abab, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,Ux,ixay,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,xy,iUax,Wy->KWCU', X_abab, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,xy,ixaz,UzWy->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('iKaC,xy,ixza,UzWy->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('iKaC,xy,ixza,UzyW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,xy,izax,UyWz->KWCU', X_abab, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('iKaC,xy,izxa,UyWz->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('iKaC,xy,izxa,UyzW->KWCU', X_abab, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,iUax,xyzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,ixay,Uxzw,Wzyw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,ixay,Uzwx,Wwzy->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,ixay,Uzyw,Wxzw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('iKaC,ixay,xzwu,UywWzu->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('iKaC,ixay,yzwu,UzuWxw->KWCU', X_abab, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('iKaC,ixya,Uzwx,Wwyz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('iKaC,ixya,Uzwx,Wwzy->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('iKaC,ixya,Uzyw,Wxwz->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('iKaC,ixya,Uzyw,Wxzw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/3 * einsum('iKaC,ixya,xzwu,UywWzu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('iKaC,ixya,xzwu,UywzWu->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/3 * einsum('iKaC,ixya,yzwu,UzuWxw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('iKaC,ixya,yzwu,UzuxWw->KWCU', X_abab, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,iUax,Wx->KWCU', X_bbbb, e_extern, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,a,iUxa,Wx->KWCU', X_bbbb, e_extern, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,ia,UW->KWCU', X_bbbb, e_extern, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,a,ixay,UyWx->KWCU', X_bbbb, e_extern, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,a,ixya,UyWx->KWCU', X_bbbb, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,a,ixya,UyxW->KWCU', X_bbbb, e_extern, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,iUax,Wx->KWCU', X_bbbb, e_cvs, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,i,iUxa,Wx->KWCU', X_bbbb, e_cvs, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,ia,UW->KWCU', X_bbbb, e_cvs, t1_xe, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,i,ixay,UyWx->KWCU', X_bbbb, e_cvs, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,i,ixya,UyWx->KWCU', X_bbbb, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,i,ixya,UyxW->KWCU', X_bbbb, e_cvs, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,Ux,ixay,Wy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,Ux,ixya,Wy->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,iUax,Wy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,xy,iUxa,Wy->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ca, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,xy,ixaz,UzWy->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,xy,ixza,UzWy->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,xy,ixza,UzyW->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,xy,izax,UyWz->KWCU', X_bbbb, h_aa, t1_xaea, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,xy,izxa,UyWz->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,xy,izxa,UyzW->KWCU', X_bbbb, h_aa, t1_xaae, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,iUax,xyzw,Wzyw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,iUxa,xyzw,Wzyw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uxzw,Wzyw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,Uzwx,Wwzy->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,Uzyw,Wxzw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/2 * einsum('KiCa,ixay,xzwu,UywWzu->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixay,yzwu,UzuWxw->KWCU', X_bbbb, t1_xaea, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/2 * einsum('KiCa,ixya,Uxzw,Wzyw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Uzwx,Wwyz->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Uzwx,Wwzy->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,Uzyw,Wxwz->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,Uzyw,Wxzw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_ccaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,xzwu,UywWzu->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,xzwu,UywzWu->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb -= 1/6 * einsum('KiCa,ixya,yzwu,UzuWxw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma_KWCU_bbbb += 1/6 * einsum('KiCa,ixya,yzwu,UzuxWw->KWCU', X_bbbb, t1_xaae, v_aaaa, rdm_cccaaa, optimize = einsum_type)
    sigma[caea__bbbb] += ascontiguousarray(sigma_KWCU_bbbb).reshape(-1)
 
    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CAEA-CCEE", *cput1)

# CVAA <- CCEE: NO CONTRIBUTION

# CVEA <- CCEE
def compute_sigma_vector__H1__h1_h1__CVEA_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    cvea__aaaa = mr_adc.h1.cvea__aaaa
    cvea__abab = mr_adc.h1.cvea__abab
    cvea__baab = mr_adc.h1.cvea__baab
    cvea__bbbb = mr_adc.h1.cvea__bbbb
    cvea__baba = mr_adc.h1.cvea__baba
    cvea__abba = mr_adc.h1.cvea__abba 
    
    ## Two-electron integrals
    v_xvae = mr_adc.v2e.xvae
    v_vaex = mr_adc.v2e.vaex
     
    # Reduced Density Matrices
    rdm_ca = mr_adc.rdm.ca

    sigma_KLCW_aaaa  = einsum('KiCa,LWai->KLCW', X_aaaa, v_vaex, optimize = einsum_type)
    sigma_KLCW_aaaa -= einsum('KiCa,iLWa->KLCW', X_aaaa, v_xvae, optimize = einsum_type)
    sigma_KLCW_aaaa += einsum('KiCa,LWai->KLCW', X_abab, v_vaex, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_aaaa, v_xvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_aaaa -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_vaex, rdm_ca, optimize = einsum_type)
    sigma[cvea__aaaa] += ascontiguousarray(sigma_KLCW_aaaa).reshape(-1)

    sigma_KLCW_abab  = einsum('KiCa,LWai->KLCW', X_aaaa, v_vaex, optimize = einsum_type)
    sigma_KLCW_abab += einsum('KiCa,LWai->KLCW', X_abab, v_vaex, optimize = einsum_type)
    sigma_KLCW_abab -= einsum('KiCa,iLWa->KLCW', X_abab, v_xvae, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_aaaa, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_abab, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_abab += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_abab, v_xvae, rdm_ca, optimize = einsum_type)
    sigma[cvea__abab] += ascontiguousarray(sigma_KLCW_abab).reshape(-1)

    sigma_KLCW_abba  = einsum('KiaC,iLWa->KLCW', X_abab, v_xvae, optimize = einsum_type)
    sigma_KLCW_abba -= 1/2 * einsum('KiaC,iLxa,Wx->KLCW', X_abab, v_xvae, rdm_ca, optimize = einsum_type)
    sigma[cvea__abba] += ascontiguousarray(sigma_KLCW_abba).reshape(-1)

    sigma_KLCW_baab  = einsum('iKCa,iLWa->KLCW', X_abab, v_xvae, optimize = einsum_type)
    sigma_KLCW_baab -= 1/2 * einsum('iKCa,iLxa,Wx->KLCW', X_abab, v_xvae, rdm_ca, optimize = einsum_type)
    sigma[cvea__baab] += ascontiguousarray(sigma_KLCW_baab).reshape(-1)

    sigma_KLCW_baba  = einsum('iKaC,LWai->KLCW', X_abab, v_vaex, optimize = einsum_type)
    sigma_KLCW_baba -= einsum('iKaC,iLWa->KLCW', X_abab, v_xvae, optimize = einsum_type)
    sigma_KLCW_baba += einsum('KiCa,LWai->KLCW', X_bbbb, v_vaex, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('iKaC,Lxai,Wx->KLCW', X_abab, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba += 1/2 * einsum('iKaC,iLxa,Wx->KLCW', X_abab, v_xvae, rdm_ca, optimize = einsum_type)
    sigma_KLCW_baba -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_vaex, rdm_ca, optimize = einsum_type)
    sigma[cvea__baba] += ascontiguousarray(sigma_KLCW_baba).reshape(-1)

    sigma_KLCW_bbbb  = einsum('iKaC,LWai->KLCW', X_abab, v_vaex, optimize = einsum_type)
    sigma_KLCW_bbbb += einsum('KiCa,LWai->KLCW', X_bbbb, v_vaex, optimize = einsum_type)
    sigma_KLCW_bbbb -= einsum('KiCa,iLWa->KLCW', X_bbbb, v_xvae, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('iKaC,Lxai,Wx->KLCW', X_abab, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb -= 1/2 * einsum('KiCa,Lxai,Wx->KLCW', X_bbbb, v_vaex, rdm_ca, optimize = einsum_type)
    sigma_KLCW_bbbb += 1/2 * einsum('KiCa,iLxa,Wx->KLCW', X_bbbb, v_xvae, rdm_ca, optimize = einsum_type)
    sigma[cvea__bbbb] += ascontiguousarray(sigma_KLCW_bbbb).reshape(-1)
 
    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CVEA-CCEE", *cput1)

# CVEE <- CCEE
def compute_sigma_vector__H1__h1_h1__CVEE_CCEE(mr_adc, X_aaaa, X_abab, X_bbbb, sigma):
    cput1 = (logger.process_clock(), logger.perf_counter())

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    #Excitation Manifold
    cvee__aaaa = mr_adc.h1.cvee__aaaa
    cvee__abab = mr_adc.h1.cvee__abab
    cvee__baba = mr_adc.h1.cvee__baba
    cvee__bbbb = mr_adc.h1.cvee__bbbb 

    ## Indices
    ee_tril_ind = mr_adc.h1.ee_tril_ind 

    ## Two-electron integrals
    v_xxvx = mr_adc.v2e.xxvx
    v_xvee = mr_adc.v2e.xvee
    v_veex = mr_adc.v2e.veex

    sigma_KLCD_aaaa  = einsum('KiCa,LDai->KLCD', X_aaaa, v_veex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiCa,iLDa->KLCD', X_aaaa, v_xvee, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_aaaa, v_veex, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiDa,iLCa->KLCD', X_aaaa, v_xvee, optimize = einsum_type)
    sigma_KLCD_aaaa += 1/2 * einsum('ijCD,KiLj->KLCD', X_aaaa, v_xxvx, optimize = einsum_type)
    sigma_KLCD_aaaa -= 1/2 * einsum('ijCD,KjLi->KLCD', X_aaaa, v_xxvx, optimize = einsum_type)
    sigma_KLCD_aaaa += einsum('KiCa,LDai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma_KLCD_aaaa -= einsum('KiDa,LCai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma[cvee__aaaa] += ascontiguousarray(sigma_KLCD_aaaa[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    sigma_KLCD_abab  = einsum('KiCa,LDai->KLCD', X_aaaa, v_veex, optimize = einsum_type)
    sigma_KLCD_abab += einsum('KiCa,LDai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiCa,iLDa->KLCD', X_abab, v_xvee, optimize = einsum_type)
    sigma_KLCD_abab -= einsum('KiaD,iLCa->KLCD', X_abab, v_xvee, optimize = einsum_type)
    sigma_KLCD_abab += einsum('ijCD,KiLj->KLCD', X_abab, v_xxvx, optimize = einsum_type)
    sigma[cvee__abab] += ascontiguousarray(sigma_KLCD_abab).reshape(-1)

    sigma_KLCD_baba =- einsum('iKDa,iLCa->KLCD', X_abab, v_xvee, optimize = einsum_type)
    sigma_KLCD_baba += einsum('iKaC,LDai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma_KLCD_baba -= einsum('iKaC,iLDa->KLCD', X_abab, v_xvee, optimize = einsum_type)
    sigma_KLCD_baba += einsum('ijDC,KjLi->KLCD', X_abab, v_xxvx, optimize = einsum_type)
    sigma_KLCD_baba += einsum('KiCa,LDai->KLCD', X_bbbb, v_veex, optimize = einsum_type)
    sigma[cvee__baba] += ascontiguousarray(sigma_KLCD_baba).reshape(-1)

    sigma_KLCD_bbbb  = einsum('iKaC,LDai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('iKaD,LCai->KLCD', X_abab, v_veex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiCa,LDai->KLCD', X_bbbb, v_veex, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiCa,iLDa->KLCD', X_bbbb, v_xvee, optimize = einsum_type)
    sigma_KLCD_bbbb -= einsum('KiDa,LCai->KLCD', X_bbbb, v_veex, optimize = einsum_type)
    sigma_KLCD_bbbb += einsum('KiDa,iLCa->KLCD', X_bbbb, v_xvee, optimize = einsum_type)
    sigma_KLCD_bbbb += 1/2 * einsum('ijCD,KiLj->KLCD', X_bbbb, v_xxvx, optimize = einsum_type)
    sigma_KLCD_bbbb -= 1/2 * einsum('ijCD,KjLi->KLCD', X_bbbb, v_xxvx, optimize = einsum_type)
    sigma[cvee__bbbb] += ascontiguousarray(sigma_KLCD_bbbb[:, :, ee_tril_ind[0], ee_tril_ind[1]]).reshape(-1)

    mr_adc.log.timer_debug("computing sigma H1 h1-h1 CVEE-CCEE", *cput1)


